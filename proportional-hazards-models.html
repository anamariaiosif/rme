<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Regression Models for Epidemiology - 6&nbsp; Proportional Hazards Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./coxph-model-building.html" rel="next">
<link href="./intro-to-survival-analysis.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-W625DGE908"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-W625DGE908', { 'anonymize_ip': true});
</script><script type="application/json" class="js-hypothesis-config">
{
  "theme": "clean",
  "openSidebar": false,
  "enableExperimentalNewNoteButton": true
}
</script><script async="" src="https://hypothes.is/embed.js"></script><script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script><link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="custom.scss">
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./time-to-event-models.html">Time to Event Models</a></li><li class="breadcrumb-item"><a href="./proportional-hazards-models.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Proportional Hazards Models</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Regression Models for Epidemiology</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/d-morrison/rme" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="./Regression-Models-for-Epidemiology.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro-to-GLMs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./glms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generalized Linear Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Linear-models-overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Linear (Gaussian) Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./logistic-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Models for Binary Outcomes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./count-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Models for Count Outcomes</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./time-to-event-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Time to Event Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro-to-survival-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Introduction to Survival Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./proportional-hazards-models.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Proportional Hazards Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./coxph-model-building.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Building Cox Proportional Hazards models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./parametric-survival-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Parametric survival models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./math-prereqs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Mathematics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./probability.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Probability</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Estimation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Inference</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro-MLEs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Introduction to Maximum Likelihood Inference</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./common-mistakes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">F</span>&nbsp; <span class="chapter-title">Common Mistakes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./notation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">G</span>&nbsp; <span class="chapter-title">Notation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro-to-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">H</span>&nbsp; <span class="chapter-title">Statistical computing in R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Contributing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">I</span>&nbsp; <span class="chapter-title">Contributing to <code>rme</code></span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#configuring-r" id="toc-configuring-r" class="nav-link active" data-scroll-target="#configuring-r">Configuring R</a></li>
  <li>
<a href="#the-proportional-hazards-model" id="toc-the-proportional-hazards-model" class="nav-link" data-scroll-target="#the-proportional-hazards-model"><span class="header-section-number">6.1</span> The proportional hazards model</a>
  <ul class="collapse">
<li><a href="#background-on-the-proportional-hazards-model" id="toc-background-on-the-proportional-hazards-model" class="nav-link" data-scroll-target="#background-on-the-proportional-hazards-model"><span class="header-section-number">6.1.1</span> Background on the Proportional Hazards Model</a></li>
  <li><a href="#coxs-proportional-hazards-model" id="toc-coxs-proportional-hazards-model" class="nav-link" data-scroll-target="#coxs-proportional-hazards-model"><span class="header-section-number">6.1.2</span> Cox’s Proportional Hazards Model</a></li>
  <li><a href="#additional-properties-of-the-proportional-hazards-model" id="toc-additional-properties-of-the-proportional-hazards-model" class="nav-link" data-scroll-target="#additional-properties-of-the-proportional-hazards-model"><span class="header-section-number">6.1.3</span> Additional properties of the proportional hazards model</a></li>
  <li><a href="#testing-the-proportional-hazards-assumption" id="toc-testing-the-proportional-hazards-assumption" class="nav-link" data-scroll-target="#testing-the-proportional-hazards-assumption"><span class="header-section-number">6.1.4</span> Testing the proportional hazards assumption</a></li>
  <li><a href="#smoothed-hazard-functions" id="toc-smoothed-hazard-functions" class="nav-link" data-scroll-target="#smoothed-hazard-functions"><span class="header-section-number">6.1.5</span> Smoothed hazard functions</a></li>
  <li><a href="#fitting-the-proportional-hazards-model" id="toc-fitting-the-proportional-hazards-model" class="nav-link" data-scroll-target="#fitting-the-proportional-hazards-model"><span class="header-section-number">6.1.6</span> Fitting the Proportional Hazards Model</a></li>
  </ul>
</li>
  <li>
<a href="#cox-model-for-the-bmt-data" id="toc-cox-model-for-the-bmt-data" class="nav-link" data-scroll-target="#cox-model-for-the-bmt-data"><span class="header-section-number">6.2</span> Cox Model for the <code>bmt</code> data</a>
  <ul class="collapse">
<li><a href="#fit-the-model" id="toc-fit-the-model" class="nav-link" data-scroll-target="#fit-the-model"><span class="header-section-number">6.2.1</span> Fit the model</a></li>
  <li><a href="#survival-curves-from-the-cox-model" id="toc-survival-curves-from-the-cox-model" class="nav-link" data-scroll-target="#survival-curves-from-the-cox-model"><span class="header-section-number">6.2.2</span> Survival Curves from the Cox Model</a></li>
  <li><a href="#examining-survfit" id="toc-examining-survfit" class="nav-link" data-scroll-target="#examining-survfit"><span class="header-section-number">6.2.3</span> Examining <code>survfit</code></a></li>
  </ul>
</li>
  <li>
<a href="#adjustment-for-ties-optional" id="toc-adjustment-for-ties-optional" class="nav-link" data-scroll-target="#adjustment-for-ties-optional"><span class="header-section-number">6.3</span> Adjustment for Ties (optional)</a>
  <ul class="collapse">
<li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"><span class="header-section-number">6.3.1</span> </a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/d-morrison/rme/edit/main/proportional-hazards-models.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/d-morrison/rme/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./time-to-event-models.html">Time to Event Models</a></li><li class="breadcrumb-item"><a href="./proportional-hazards-models.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Proportional Hazards Models</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Proportional Hazards Models</span>
</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Last modified: 2024-05-02: 18:10:45 (PM)</p>
    </div>
  </div>
  
    
  </div>
  


</header><hr>
<!-- ::: {.content-hidden when-format="revealjs"} --><hr>
<section id="configuring-r" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="configuring-r">Configuring R</h3>
<p>Functions from these packages will be used throughout this document:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://conflicted.r-lib.org/">conflicted</a></span><span class="op">)</span> <span class="co"># check for conflicting function definitions</span></span>
<span><span class="co"># library(printr) # inserts help-file output into markdown output</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/rmarkdown">rmarkdown</a></span><span class="op">)</span> <span class="co"># Convert R Markdown documents into a variety of formats.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rapporter.github.io/pander/">pander</a></span><span class="op">)</span> <span class="co"># format tables for markdown</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span> <span class="co"># graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jonocarroll/ggeasy">ggeasy</a></span><span class="op">)</span> <span class="co"># help with graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sinhrks/ggfortify">ggfortify</a></span><span class="op">)</span> <span class="co"># help with graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span> <span class="co"># manipulate data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/">tibble</a></span><span class="op">)</span> <span class="co"># `tibble`s extend `data.frame`s</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span> <span class="co"># `%&gt;%` and other additional piping tools</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://haven.tidyverse.org">haven</a></span><span class="op">)</span> <span class="co"># import Stata files</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span> <span class="co"># format R output for markdown</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span> <span class="co"># Tools to help to create tidy data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://plotly-r.com">plotly</a></span><span class="op">)</span> <span class="co"># interactive graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">dobson</span><span class="op">)</span> <span class="co"># datasets from Dobson and Barnett 2018</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://easystats.github.io/parameters/">parameters</a></span><span class="op">)</span> <span class="co"># format model output tables for markdown</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://haven.tidyverse.org">haven</a></span><span class="op">)</span> <span class="co"># import Stata files</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stefanom.io/latex2exp/">latex2exp</a></span><span class="op">)</span> <span class="co"># use LaTeX in R code (for figures and tables)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://fs.r-lib.org">fs</a></span><span class="op">)</span> <span class="co"># filesystem path manipulations</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span> <span class="co"># survival analysis</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/survminer/index.html">survminer</a></span><span class="op">)</span> <span class="co"># survival analysis graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">KMsurv</span><span class="op">)</span> <span class="co"># datasets from Klein and Moeschberger</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://easystats.github.io/parameters/">parameters</a></span><span class="op">)</span> <span class="co"># format model output tables for</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/webshot2/">webshot2</a></span><span class="op">)</span> <span class="co"># convert interactive content to static for pdf</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://forcats.tidyverse.org/">forcats</a></span><span class="op">)</span> <span class="co"># functions for categorical variables ("factors")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org">stringr</a></span><span class="op">)</span> <span class="co"># functions for dealing with strings</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span> <span class="co"># functions for dealing with dates and times</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here are some R settings I use in this document:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="co"># delete any data that's already loaded into R</span></span>
<span></span>
<span><span class="fu"><a href="https://conflicted.r-lib.org/reference/conflicts_prefer.html">conflicts_prefer</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">)</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op">(</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="co"># ggplot2::labs(col = "") +</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>      legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>      text <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, family <span class="op">=</span> <span class="st">"serif"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>message <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="st">'digits'</span> <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/panderOptions.html">panderOptions</a></span><span class="op">(</span><span class="st">"big.mark"</span>, <span class="st">","</span><span class="op">)</span></span>
<span><span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/panderOptions.html">panderOptions</a></span><span class="op">(</span><span class="st">"table.emphasize.rownames"</span>, <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/panderOptions.html">panderOptions</a></span><span class="op">(</span><span class="st">"table.split.table"</span>, <span class="cn">Inf</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://conflicted.r-lib.org/reference/conflicts_prefer.html">conflicts_prefer</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">)</span> <span class="co"># use the `filter()` function from dplyr() by default</span></span>
<span><span class="va">legend_text_size</span> <span class="op">=</span> <span class="fl">9</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<!-- ::: -->
<style>
.quarto-figure-center > figure {
text-align: center;
}
</style></section><section id="the-proportional-hazards-model" class="level2" data-number="6.1"><h2 data-number="6.1" class="anchored" data-anchor-id="the-proportional-hazards-model">
<span class="header-section-number">6.1</span> The proportional hazards model</h2>
<section id="background-on-the-proportional-hazards-model" class="level3" data-number="6.1.1"><h3 data-number="6.1.1" class="anchored" data-anchor-id="background-on-the-proportional-hazards-model">
<span class="header-section-number">6.1.1</span> Background on the Proportional Hazards Model</h3>
<p>The exponential distribution has constant hazard:</p>
<p><span class="math display">\[
\begin{aligned}
f(t) &amp;= \lambda e^{-\lambda t}\\
S(t) &amp;= e^{-\lambda t}\\
h(t) &amp;= \lambda
\end{aligned}
\]</span></p>
<p>Let’s make two generalizations. First, we let the hazard depend on some covariates <span class="math inline">\(x_1,x_2, \dots, x_p\)</span>; we will indicate this dependence by extending our notation for hazard:</p>
<p><span class="math display">\[h(t|\boldsymbol x) \stackrel{\text{def}}{=}p(T=t|T\ge t, \boldsymbol X = \boldsymbol x)\]</span></p>
<p>Second, we let the base hazard depend on <span class="math inline">\(t\)</span>, but not on the covariates (for now). We can do this using either parametric or semi-parametric approaches.</p>
</section><section id="coxs-proportional-hazards-model" class="level3" data-number="6.1.2"><h3 data-number="6.1.2" class="anchored" data-anchor-id="coxs-proportional-hazards-model">
<span class="header-section-number">6.1.2</span> Cox’s Proportional Hazards Model</h3>
<p>The generalization is that the hazard function is</p>
<p><span class="math display">\[
\begin{aligned}
h(t|x)&amp;= h_0(t)\theta(x)\\
\theta(x) &amp;= \text{exp}\left\{\eta(x)\right\}\\
\eta(x) &amp;= x'\beta\\
&amp;\stackrel{\text{def}}{=}\beta_1x_1+\cdots+\beta_px_p
\end{aligned}
\]</span></p>
<p>The relationship between <span class="math inline">\(h(t|x)\)</span> and <span class="math inline">\(\eta(x)\)</span> has a log link (that is, <span class="math inline">\(\text{log}\left\{h(t|x)\right\} = \text{log}\left\{h_0(t)\right\} + \eta(x)\)</span>), as in a generalized linear model.</p>
<p>This model is <strong>semi-parametric</strong>, because the linear predictor depends on estimated parameters but the base hazard function is unspecified. There is no constant term in <span class="math inline">\(\eta(x)\)</span>, because it is absorbed in the base hazard.</p>
<p>Alternatively, we could define <span class="math inline">\(\beta_0(t) = \text{log}\left\{h_0(t)\right\}\)</span>, and then <span class="math inline">\(\eta(x,t) = \beta_0(t) + \beta_1x_1+\cdots+\beta_px_p\)</span>.</p>
<p>For two different individuals with covariate patterns <span class="math inline">\(\boldsymbol x_1\)</span> and <span class="math inline">\(\boldsymbol x_2\)</span>, the ratio of the hazard functions (a.k.a. <strong>hazard ratio</strong>, a.k.a. <strong>relative hazard</strong>) is:</p>
<p><span class="math display">\[
\begin{aligned}
\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}
&amp;=\frac{h_0(t)\theta(\boldsymbol x_1)}{h_0(t)\theta(\boldsymbol x_2)}\\
&amp;=\frac{\theta(\boldsymbol x_1)}{\theta(\boldsymbol x_2)}\\
\end{aligned}
\]</span></p>
<p>Under the proportional hazards model, this ratio (a.k.a. proportion) does not depend on <span class="math inline">\(t\)</span>. This property is a structural limitation of the model; it is called the <strong>proportional hazards assumption</strong>.</p>
<div id="def-pha" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.1 (proportional hazards)</strong></span> A conditional probability distribution <span class="math inline">\(p(T|X)\)</span> has <strong>proportional hazards</strong> if the hazard ratio <span class="math inline">\(h(t|\boldsymbol x_1)/h(t|\boldsymbol x_2)\)</span> does not depend on <span class="math inline">\(t\)</span>. Mathematically, it can be written as:</p>
<p><span class="math display">\[
\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}
= \theta(\boldsymbol x_1,\boldsymbol x_2)
\]</span></p>
</div>
<p>As we saw above, Cox’s proportional hazards model has this property, with <span class="math inline">\(\theta(\boldsymbol x_1,\boldsymbol x_2) = \frac{\theta(\boldsymbol x_1)}{\theta(\boldsymbol x_2)}\)</span>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We are using two similar notations, <span class="math inline">\(\theta(\boldsymbol x_1,\boldsymbol x_2)\)</span> and <span class="math inline">\(\theta(\boldsymbol x)\)</span>. We can link these notations if we define <span class="math inline">\(\theta(\boldsymbol x) \stackrel{\text{def}}{=}\theta(\boldsymbol x, \boldsymbol 0)\)</span> and <span class="math inline">\(\theta(\boldsymbol 0) = 1\)</span>.</p>
</div>
</div>
<p>It also has additional notable properties:</p>
<p><span class="math display">\[
\begin{aligned}
\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}
&amp;=\frac{\theta(\boldsymbol x_1)}{\theta(\boldsymbol x_2)}\\
&amp;=\frac{\text{exp}\left\{\eta(\boldsymbol x_1)\right\}}{\text{exp}\left\{\eta(\boldsymbol x_2)\right\}}\\
&amp;=\text{exp}\left\{\eta(\boldsymbol x_1)-\eta(\boldsymbol x_2)\right\}\\
&amp;=\text{exp}\left\{\boldsymbol x_1'\beta-\boldsymbol x_2'\beta\right\}\\
&amp;=\text{exp}\left\{(\boldsymbol x_1 - \boldsymbol x_2)'\beta\right\}\\
\end{aligned}
\]</span></p>
<p>Hence on the log scale, we have:</p>
<p><span class="math display">\[
\begin{aligned}
\text{log}\left\{\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}\right\}
&amp;=\eta(\boldsymbol x_1)-\eta(\boldsymbol x_2)\\
&amp;= \boldsymbol x_1'\beta-\boldsymbol x_2'\beta\\
&amp;= (\boldsymbol x_1 - \boldsymbol x_2)'\beta
\end{aligned}
\]</span></p>
<p>If only one covariate <span class="math inline">\(x_j\)</span> is changing, then:</p>
<p><span class="math display">\[
\begin{aligned}
\text{log}\left\{\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}\right\}
&amp;=  (x_{1j} - x_{2j}) \cdot \beta_j\\
&amp;\propto (x_{1j} - x_{2j})
\end{aligned}
\]</span></p>
<p>That is, under Cox’s model <span class="math inline">\(h(t|\boldsymbol x) = h_0(t)\text{exp}\left\{\boldsymbol x'\beta\right\}\)</span>, the log of the hazard ratio is proportional to the difference in <span class="math inline">\(x_j\)</span>, with the proportionality coefficient equal to <span class="math inline">\(\beta_j\)</span>.</p>
<p>Further,</p>
<p><span class="math display">\[
\begin{aligned}
\text{log}\left\{h(t|\boldsymbol x)\right\}
&amp;=\text{log}\left\{h_0(t)\right\}  + x'\beta
\end{aligned}
\]</span></p>
<p>That is, the covariate effects are additive on the log-hazard scale.</p>
<p>See also:</p>
<p><a href="https://en.wikipedia.org/wiki/Proportional_hazards_model#Why_it_is_called_%22proportional%22" class="uri">https://en.wikipedia.org/wiki/Proportional_hazards_model#Why_it_is_called_%22proportional%22</a></p>
</section><section id="additional-properties-of-the-proportional-hazards-model" class="level3" data-number="6.1.3"><h3 data-number="6.1.3" class="anchored" data-anchor-id="additional-properties-of-the-proportional-hazards-model">
<span class="header-section-number">6.1.3</span> Additional properties of the proportional hazards model</h3>
<p>If <span class="math inline">\(h(t|x)= h_0(t)\theta(x)\)</span>, then:</p>
<section id="cumulative-hazards-are-also-proportional-to-h_0t" class="level4"><h4 class="anchored" data-anchor-id="cumulative-hazards-are-also-proportional-to-h_0t">Cumulative hazards are also proportional to <span class="math inline">\(H_0(t)\)</span>
</h4>
<p><span class="math display">\[
\begin{aligned}
H(t|x)
&amp;\stackrel{\text{def}}{=}\int_{u=0}^t h(u)du\\
&amp;= \int_{u=0}^t h_0(u)\theta(x)du\\
&amp;= \theta(x)\int_{u=0}^t h_0(u)du\\
&amp;= \theta(x)H_0(t)
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(H_0(t) \stackrel{\text{def}}{=}H(t|0) = \int_{u=0}^t h_0(u)du\)</span>.</p>
</section><section id="survival-functions-are-exponential-multiples-of-s_0t" class="level4"><h4 class="anchored" data-anchor-id="survival-functions-are-exponential-multiples-of-s_0t">Survival functions are exponential multiples of <span class="math inline">\(S_0(t)\)</span>
</h4>
<p><span class="math display">\[
\begin{aligned}
S(t|x)
&amp;= \text{exp}\left\{-H(t|x)\right\}\\
&amp;= \text{exp}\left\{-\theta(x)\cdot H_0(t)\right\}\\
&amp;= \left(\text{exp}\left\{- H_0(t)\right\}\right)^{\theta(x)}\\
&amp;= \left(S_0(t)\right)^{\theta(x)}\\
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(S_0(t) \stackrel{\text{def}}{=}P(T\ge t | \boldsymbol X = 0)\)</span> is the survival function for an individual whose covariates are all equal to their default values.</p>
</section></section><section id="testing-the-proportional-hazards-assumption" class="level3" data-number="6.1.4"><h3 data-number="6.1.4" class="anchored" data-anchor-id="testing-the-proportional-hazards-assumption">
<span class="header-section-number">6.1.4</span> Testing the proportional hazards assumption</h3>
<p>The Nelson-Aalen estimate of the cumulative hazard is usually used for estimates of the hazard and often the cumulative hazard.</p>
<p>If the hazards of the three groups are proportional, that means that the ratio of the hazards is constant over <span class="math inline">\(t\)</span>. We can test this using the ratios of the estimated cumulative hazards, which also would be proportional, as shown above.</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">KMsurv</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmt</span> <span class="op">=</span> </span>
<span>  <span class="va">bmt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    group <span class="op">=</span> </span>
<span>      <span class="va">group</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span></span>
<span>        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ALL"</span>,<span class="st">"Low Risk AML"</span>,<span class="st">"High Risk AML"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nafit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>,<span class="va">d3</span><span class="op">)</span> <span class="op">~</span> <span class="va">group</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"fleming-harrington"</span>,</span>
<span>  data <span class="op">=</span> <span class="va">bmt</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmt_curves</span> <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>timevec <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">sf1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">nafit</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/stats/stepfun.html">stepfun</a></span><span class="op">(</span><span class="va">time</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">surv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sf2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">nafit</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/stats/stepfun.html">stepfun</a></span><span class="op">(</span><span class="va">time</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">surv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sf3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">nafit</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/stats/stepfun.html">stepfun</a></span><span class="op">(</span><span class="va">time</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">surv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmt_curves</span> <span class="op">=</span> </span>
<span>  <span class="va">bmt_curves</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    cumhaz1 <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu">sf1</span><span class="op">(</span><span class="va">timevec</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    cumhaz2 <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu">sf2</span><span class="op">(</span><span class="va">timevec</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    cumhaz3 <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu">sf3</span><span class="op">(</span><span class="va">timevec</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">bmt_rel_hazard_plot</span> <span class="op">=</span> </span>
<span>  <span class="va">bmt_curves</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">timevec</span>,</span>
<span>      y <span class="op">=</span> <span class="va">cumhaz1</span><span class="op">/</span><span class="va">cumhaz2</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"ALL/Low Risk AML"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Hazard Ratio"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Time"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">cumhaz3</span><span class="op">/</span><span class="va">cumhaz1</span>, col <span class="op">=</span> <span class="st">"High Risk AML/ALL"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">cumhaz3</span><span class="op">/</span><span class="va">cumhaz2</span>, col <span class="op">=</span> <span class="st">"High Risk AML/Low Risk AML"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"Comparison"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">bmt_rel_hazard_plot</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption>Hazard Ratios by Disease Group</figcaption><p><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can zoom in on 30-300 days to take a closer look:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt_rel_hazard_plot</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">30</span>,<span class="fl">300</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption>Hazard Ratios by Disease Group (30-300 Days)</figcaption><p><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="smoothed-hazard-functions" class="level3" data-number="6.1.5"><h3 data-number="6.1.5" class="anchored" data-anchor-id="smoothed-hazard-functions">
<span class="header-section-number">6.1.5</span> Smoothed hazard functions</h3>
<p>The Nelson-Aalen estimate of the cumulative hazard is usually used for estimates of the hazard. Since the hazard is the derivative of the cumulative hazard, we need a smooth estimate of the cumulative hazard, which is provided by smoothing the step-function cumulative hazard.</p>
<p>The R package <code>muhaz</code> handles this for us. What we are looking for is whether the hazard function is more or less the same shape, increasing, decreasing, constant, etc. Are the hazards “proportional”?</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>,<span class="va">d3</span><span class="op">)</span><span class="op">~</span><span class="va">group</span>,data<span class="op">=</span><span class="va">bmt</span><span class="op">)</span>,</span>
<span>  col<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,</span>
<span>  lwd<span class="op">=</span><span class="fl">2</span>,</span>
<span>  fun<span class="op">=</span><span class="st">"cumhaz"</span>,</span>
<span>  mark.time <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"bottomright"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ALL"</span>,<span class="st">"Low Risk AML"</span>,<span class="st">"High Risk AML"</span><span class="op">)</span>,col<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption>Disease-Free Cumulative Hazard by Disease Group</figcaption><p><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">muhaz</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/muhaz/man/muhaz.html">muhaz</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">t2</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">d3</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">==</span><span class="st">"High Risk AML"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">2</span>,col<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/muhaz/man/muhaz.html">muhaz</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">t2</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">d3</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">==</span><span class="st">"ALL"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">2</span>,col<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/muhaz/man/muhaz.html">muhaz</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">t2</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">d3</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">==</span><span class="st">"Low Risk AML"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">2</span>,col<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topright"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ALL"</span>,<span class="st">"Low Risk AML"</span>,<span class="st">"High Risk AML"</span><span class="op">)</span>,col<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption>Smoothed Hazard Rate Estimates by Disease Group</figcaption><p><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Group 3 was plotted first because it has the highest hazard.</p>
<p>We will see that except for an initial blip in the high risk AML group, the hazards look roughly proportional . They are all strongly decreasing.</p>
</section><section id="fitting-the-proportional-hazards-model" class="level3" data-number="6.1.6"><h3 data-number="6.1.6" class="anchored" data-anchor-id="fitting-the-proportional-hazards-model">
<span class="header-section-number">6.1.6</span> Fitting the Proportional Hazards Model</h3>
<p>How do we fit a proportional hazards regression model? We need to estimate the coefficients of the covariates, and we need to estimate the base hazard <span class="math inline">\(h_0(t)\)</span>. For the covariates, supposing for simplicity that there are no tied event times, let the event times for the whole data set be <span class="math inline">\(t_1, t_2,\ldots,t_D\)</span>. Let the risk set at time <span class="math inline">\(t_i\)</span> be <span class="math inline">\(R(t_i)\)</span> and</p>
<p><span class="math display">\[
\begin{aligned}
\eta(\boldsymbol{x}) &amp;= \beta_1x_{1}+\cdots+\beta_p x_{p}\\
\theta(\boldsymbol{x}) &amp;= e^{\eta(\boldsymbol{x})}\\
h(t|X=x)&amp;= h_0(t)e^{\eta(\boldsymbol{x})}=\theta(\boldsymbol{x}) h_0(t)
\end{aligned}
\]</span></p>
<p>Conditional on a single failure at time <span class="math inline">\(t\)</span>, the probability that the event is due to subject <span class="math inline">\(f\in R(t)\)</span> is approximately</p>
<p><span class="math display">\[
\begin{aligned}
\Pr(f \text{ fails}|\text{1 failure at } t)
&amp;= \frac{h_0(t)e^{\eta(\boldsymbol{x}_f)}}{\sum_{k \in R(t)}h_0(t)e^{\eta(\boldsymbol{x}_f)}}\\
&amp;=\frac{\theta(\boldsymbol{x}_f)}{\sum_{k \in R(t)} \theta(\boldsymbol{x}_k)}
\end{aligned}
\]</span></p>
<p>The logic behind this has several steps. We first fix (ex post) the failure times and note that in this discrete context, the probability <span class="math inline">\(p_j\)</span> that a subject <span class="math inline">\(j\)</span> in the risk set fails at time <span class="math inline">\(t\)</span> is just the hazard of that subject at that time.</p>
<p>If all of the <span class="math inline">\(p_j\)</span> are small, the chance that exactly one subject fails is</p>
<p><span class="math display">\[
\sum_{k\in R(t)}p_k\left[\prod_{m\in R(t), m\ne k} (1-p_m)\right]\approx\sum_{k\in R(t)}p_k
\]</span></p>
<p>If subject <span class="math inline">\(i\)</span> is the one who experiences the event of interest at time <span class="math inline">\(t_i\)</span>, then the <strong>partial likelihood</strong> is</p>
<p><span class="math display">\[
\mathcal L^*(\beta|T)=
\prod_i \frac{\theta(x_i)}{\sum_{k \in R(t_i)} \theta(\boldsymbol{x}_k)}
\]</span></p>
<p>and we can numerically maximize this with respect to the coefficients <span class="math inline">\(\boldsymbol{\beta}\)</span> that specify <span class="math inline">\(\eta(\boldsymbol{x}) = \boldsymbol{x}'\boldsymbol{\beta}\)</span>. When there are tied event times adjustments need to be made, but the likelihood is still similar. Note that we don’t need to know the base hazard to solve for the coefficients.</p>
<p>Once we have coefficient estimates <span class="math inline">\(\hat{\boldsymbol{\beta}} =(\hat \beta_1,\ldots,\hat\beta_p)\)</span>, this also defines <span class="math inline">\(\hat\eta(x)\)</span> and <span class="math inline">\(\hat\theta(x)\)</span> and then the estimated base cumulative hazard function is <span class="math display">\[\hat H(t)=
\sum_{t_i &lt; t} \frac{d_i}{\sum_{k\in R(t_i)} \theta(x_k)}\]</span> which reduces to the Nelson-Aalen estimate when there are no covariates. There are numerous other estimates that have been proposed as well.</p>
</section></section><section id="cox-model-for-the-bmt-data" class="level2" data-number="6.2"><h2 data-number="6.2" class="anchored" data-anchor-id="cox-model-for-the-bmt-data">
<span class="header-section-number">6.2</span> Cox Model for the <code>bmt</code> data</h2>
<section id="fit-the-model" class="level3" data-number="6.2.1"><h3 data-number="6.2.1" class="anchored" data-anchor-id="fit-the-model">
<span class="header-section-number">6.2.1</span> Fit the model</h3>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="va">bmt.cox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">d3</span><span class="op">)</span> <span class="op">~</span> <span class="va">group</span>, data <span class="op">=</span> <span class="va">bmt</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">bmt.cox</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = Surv(t2, d3) ~ group, data = bmt)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 137, number of events= 83 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                      coef exp(coef) se(coef)     z Pr(&gt;|z|)  </span></span>
<span><span class="co">#&gt; groupLow Risk AML  -0.574     0.563    0.287 -2.00    0.046 *</span></span>
<span><span class="co">#&gt; groupHigh Risk AML  0.383     1.467    0.267  1.43    0.152  </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                    exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; groupLow Risk AML      0.563      1.776     0.321     0.989</span></span>
<span><span class="co">#&gt; groupHigh Risk AML     1.467      0.682     0.869     2.478</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.625  (se = 0.03 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 13.4  on 2 df,   p=0.001</span></span>
<span><span class="co">#&gt; Wald test            = 13  on 2 df,   p=0.001</span></span>
<span><span class="co">#&gt; Score (logrank) test = 13.8  on 2 df,   p=0.001</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The table provides hypothesis tests comparing groups 2 and 3 to group 1. Group 3 has the highest hazard, so the most significant comparison is not directly shown.</p>
<p>The coefficient 0.3834 is on the log-hazard-ratio scale, as in log-risk-ratio. The next column gives the hazard ratio 1.4673, and a hypothesis (Wald) test.</p>
<p>The (not shown) group 3 vs.&nbsp;group 2 log hazard ratio is 0.3834 + 0.5742 = 0.9576. The hazard ratio is then exp(0.9576) or 2.605.</p>
<p>Inference on all coefficients and combinations can be constructed using <code>coef(bmt.cox)</code> and <code>vcov(bmt.cox)</code> as with logistic and poisson regression.</p>
<p><strong>Concordance</strong> is agreement of first failure between pairs of subjects and higher predicted risk between those subjects, omitting non-informative pairs.</p>
<p>The Rsquare value is Cox and Snell’s pseudo R-squared and is not very useful.</p>
<p><code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> prints three tests for whether the model with the group covariate is better than the one without</p>
<ul>
<li>
<code>Likelihood ratio test</code> (chi-squared)</li>
<li>
<code>Wald test</code> (also chi-squared), obtained by adding the squares of the z-scores</li>
<li>
<code>Score</code> = log-rank test, as with comparison of survival functions.</li>
</ul>
<p>The likelihood ratio test is probably best in smaller samples, followed by the Wald test.</p>
</section><section id="survival-curves-from-the-cox-model" class="level3" data-number="6.2.2"><h3 data-number="6.2.2" class="anchored" data-anchor-id="survival-curves-from-the-cox-model">
<span class="header-section-number">6.2.2</span> Survival Curves from the Cox Model</h3>
<p>We can take a look at the resulting group-specific curves:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="co">#| fig-cap: "Survival Functions for Three Groups by KM and Cox Model"</span></span>
<span></span>
<span><span class="va">km_fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">d3</span><span class="op">)</span> <span class="op">~</span> <span class="va">group</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cox_fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span></span>
<span>  <span class="va">bmt.cox</span>, </span>
<span>  newdata <span class="op">=</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>      group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">)</span>, </span>
<span>      row.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/survminer/index.html">survminer</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>KM <span class="op">=</span> <span class="va">km_fit</span>, Cox <span class="op">=</span> <span class="va">cox_fit</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">survminer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html">ggsurvplot</a></span><span class="op">(</span></span>
<span>    <span class="co"># facet.by = "group",</span></span>
<span>    legend <span class="op">=</span> <span class="st">"bottom"</span>, </span>
<span>    legend.title <span class="op">=</span> <span class="st">""</span>,</span>
<span>    combine <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>    fun <span class="op">=</span> <span class="st">'pct'</span>, </span>
<span>    size <span class="op">=</span> <span class="fl">.5</span>,</span>
<span>    ggtheme <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>    conf.int <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>    censor <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># ggsurvplot() throws some warnings that aren't too worrying</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>When we use <code><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit()</a></code> with a Cox model, we have to specify the covariate levels we are interested in; the argument <code>newdata</code> should include a <code>data.frame</code> with the same named columns as the predictors in the Cox model and one or more levels of each.</p>
<p>Otherwise (that is, if the <code>newdata</code> argument is missing), a curve is produced for a single “pseudo” subject with covariate values equal to the means component of the fit.</p>
<p>The resulting curve(s) almost never make sense, but the default remains due to an unwarranted attachment to the option shown by some users and by other packages.</p>
<p>Two particularly egregious examples are factor variables and interactions. Suppose one were studying interspecies transmission of a virus, and the data set has a factor variable with levels (“pig”, “chicken”) and about equal numbers of observations for each. The “mean” covariate level will be 0.5 – is this a flying pig?</p>
</section><section id="examining-survfit" class="level3" data-number="6.2.3"><h3 data-number="6.2.3" class="anchored" data-anchor-id="examining-survfit">
<span class="header-section-number">6.2.3</span> Examining <code>survfit</code>
</h3>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">d3</span><span class="op">)</span><span class="op">~</span><span class="va">group</span>,data<span class="op">=</span><span class="va">bmt</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call: survfit(formula = Surv(t2, d3) ~ group, data = bmt)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                      n events median 0.95LCL 0.95UCL</span></span>
<span><span class="co">#&gt; group=ALL           38     24    418     194      NA</span></span>
<span><span class="co">#&gt; group=Low Risk AML  54     25   2204     704      NA</span></span>
<span><span class="co">#&gt; group=High Risk AML 45     34    183     115     456</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">d3</span><span class="op">)</span><span class="op">~</span><span class="va">group</span>,data<span class="op">=</span><span class="va">bmt</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call: survfit(formula = Surv(t2, d3) ~ group, data = bmt)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                 group=ALL </span></span>
<span><span class="co">#&gt;  time n.risk n.event survival std.err lower 95% CI upper 95% CI</span></span>
<span><span class="co">#&gt;     1     38       1    0.974  0.0260        0.924        1.000</span></span>
<span><span class="co">#&gt;    55     37       1    0.947  0.0362        0.879        1.000</span></span>
<span><span class="co">#&gt;    74     36       1    0.921  0.0437        0.839        1.000</span></span>
<span><span class="co">#&gt;    86     35       1    0.895  0.0498        0.802        0.998</span></span>
<span><span class="co">#&gt;   104     34       1    0.868  0.0548        0.767        0.983</span></span>
<span><span class="co">#&gt;   107     33       1    0.842  0.0592        0.734        0.966</span></span>
<span><span class="co">#&gt;   109     32       1    0.816  0.0629        0.701        0.949</span></span>
<span><span class="co">#&gt;   110     31       1    0.789  0.0661        0.670        0.930</span></span>
<span><span class="co">#&gt;   122     30       2    0.737  0.0714        0.609        0.891</span></span>
<span><span class="co">#&gt;   129     28       1    0.711  0.0736        0.580        0.870</span></span>
<span><span class="co">#&gt;   172     27       1    0.684  0.0754        0.551        0.849</span></span>
<span><span class="co">#&gt;   192     26       1    0.658  0.0770        0.523        0.827</span></span>
<span><span class="co">#&gt;   194     25       1    0.632  0.0783        0.495        0.805</span></span>
<span><span class="co">#&gt;   230     23       1    0.604  0.0795        0.467        0.782</span></span>
<span><span class="co">#&gt;   276     22       1    0.577  0.0805        0.439        0.758</span></span>
<span><span class="co">#&gt;   332     21       1    0.549  0.0812        0.411        0.734</span></span>
<span><span class="co">#&gt;   383     20       1    0.522  0.0817        0.384        0.709</span></span>
<span><span class="co">#&gt;   418     19       1    0.494  0.0819        0.357        0.684</span></span>
<span><span class="co">#&gt;   466     18       1    0.467  0.0818        0.331        0.658</span></span>
<span><span class="co">#&gt;   487     17       1    0.439  0.0815        0.305        0.632</span></span>
<span><span class="co">#&gt;   526     16       1    0.412  0.0809        0.280        0.605</span></span>
<span><span class="co">#&gt;   609     14       1    0.382  0.0803        0.254        0.577</span></span>
<span><span class="co">#&gt;   662     13       1    0.353  0.0793        0.227        0.548</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                 group=Low Risk AML </span></span>
<span><span class="co">#&gt;  time n.risk n.event survival std.err lower 95% CI upper 95% CI</span></span>
<span><span class="co">#&gt;    10     54       1    0.981  0.0183        0.946        1.000</span></span>
<span><span class="co">#&gt;    35     53       1    0.963  0.0257        0.914        1.000</span></span>
<span><span class="co">#&gt;    48     52       1    0.944  0.0312        0.885        1.000</span></span>
<span><span class="co">#&gt;    53     51       1    0.926  0.0356        0.859        0.998</span></span>
<span><span class="co">#&gt;    79     50       1    0.907  0.0394        0.833        0.988</span></span>
<span><span class="co">#&gt;    80     49       1    0.889  0.0428        0.809        0.977</span></span>
<span><span class="co">#&gt;   105     48       1    0.870  0.0457        0.785        0.965</span></span>
<span><span class="co">#&gt;   211     47       1    0.852  0.0483        0.762        0.952</span></span>
<span><span class="co">#&gt;   219     46       1    0.833  0.0507        0.740        0.939</span></span>
<span><span class="co">#&gt;   248     45       1    0.815  0.0529        0.718        0.925</span></span>
<span><span class="co">#&gt;   272     44       1    0.796  0.0548        0.696        0.911</span></span>
<span><span class="co">#&gt;   288     43       1    0.778  0.0566        0.674        0.897</span></span>
<span><span class="co">#&gt;   381     42       1    0.759  0.0582        0.653        0.882</span></span>
<span><span class="co">#&gt;   390     41       1    0.741  0.0596        0.633        0.867</span></span>
<span><span class="co">#&gt;   414     40       1    0.722  0.0610        0.612        0.852</span></span>
<span><span class="co">#&gt;   421     39       1    0.704  0.0621        0.592        0.837</span></span>
<span><span class="co">#&gt;   481     38       1    0.685  0.0632        0.572        0.821</span></span>
<span><span class="co">#&gt;   486     37       1    0.667  0.0642        0.552        0.805</span></span>
<span><span class="co">#&gt;   606     36       1    0.648  0.0650        0.533        0.789</span></span>
<span><span class="co">#&gt;   641     35       1    0.630  0.0657        0.513        0.773</span></span>
<span><span class="co">#&gt;   704     34       1    0.611  0.0663        0.494        0.756</span></span>
<span><span class="co">#&gt;   748     33       1    0.593  0.0669        0.475        0.739</span></span>
<span><span class="co">#&gt;  1063     26       1    0.570  0.0681        0.451        0.720</span></span>
<span><span class="co">#&gt;  1074     25       1    0.547  0.0691        0.427        0.701</span></span>
<span><span class="co">#&gt;  2204      6       1    0.456  0.1012        0.295        0.704</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                 group=High Risk AML </span></span>
<span><span class="co">#&gt;  time n.risk n.event survival std.err lower 95% CI upper 95% CI</span></span>
<span><span class="co">#&gt;     2     45       1    0.978  0.0220        0.936        1.000</span></span>
<span><span class="co">#&gt;    16     44       1    0.956  0.0307        0.897        1.000</span></span>
<span><span class="co">#&gt;    32     43       1    0.933  0.0372        0.863        1.000</span></span>
<span><span class="co">#&gt;    47     42       2    0.889  0.0468        0.802        0.986</span></span>
<span><span class="co">#&gt;    48     40       1    0.867  0.0507        0.773        0.972</span></span>
<span><span class="co">#&gt;    63     39       1    0.844  0.0540        0.745        0.957</span></span>
<span><span class="co">#&gt;    64     38       1    0.822  0.0570        0.718        0.942</span></span>
<span><span class="co">#&gt;    74     37       1    0.800  0.0596        0.691        0.926</span></span>
<span><span class="co">#&gt;    76     36       1    0.778  0.0620        0.665        0.909</span></span>
<span><span class="co">#&gt;    80     35       1    0.756  0.0641        0.640        0.892</span></span>
<span><span class="co">#&gt;    84     34       1    0.733  0.0659        0.615        0.875</span></span>
<span><span class="co">#&gt;    93     33       1    0.711  0.0676        0.590        0.857</span></span>
<span><span class="co">#&gt;   100     32       1    0.689  0.0690        0.566        0.838</span></span>
<span><span class="co">#&gt;   105     31       1    0.667  0.0703        0.542        0.820</span></span>
<span><span class="co">#&gt;   113     30       1    0.644  0.0714        0.519        0.801</span></span>
<span><span class="co">#&gt;   115     29       1    0.622  0.0723        0.496        0.781</span></span>
<span><span class="co">#&gt;   120     28       1    0.600  0.0730        0.473        0.762</span></span>
<span><span class="co">#&gt;   157     27       1    0.578  0.0736        0.450        0.742</span></span>
<span><span class="co">#&gt;   162     26       1    0.556  0.0741        0.428        0.721</span></span>
<span><span class="co">#&gt;   164     25       1    0.533  0.0744        0.406        0.701</span></span>
<span><span class="co">#&gt;   168     24       1    0.511  0.0745        0.384        0.680</span></span>
<span><span class="co">#&gt;   183     23       1    0.489  0.0745        0.363        0.659</span></span>
<span><span class="co">#&gt;   242     22       1    0.467  0.0744        0.341        0.638</span></span>
<span><span class="co">#&gt;   268     21       1    0.444  0.0741        0.321        0.616</span></span>
<span><span class="co">#&gt;   273     20       1    0.422  0.0736        0.300        0.594</span></span>
<span><span class="co">#&gt;   318     19       1    0.400  0.0730        0.280        0.572</span></span>
<span><span class="co">#&gt;   363     18       1    0.378  0.0723        0.260        0.550</span></span>
<span><span class="co">#&gt;   390     17       1    0.356  0.0714        0.240        0.527</span></span>
<span><span class="co">#&gt;   422     16       1    0.333  0.0703        0.221        0.504</span></span>
<span><span class="co">#&gt;   456     15       1    0.311  0.0690        0.201        0.481</span></span>
<span><span class="co">#&gt;   467     14       1    0.289  0.0676        0.183        0.457</span></span>
<span><span class="co">#&gt;   625     13       1    0.267  0.0659        0.164        0.433</span></span>
<span><span class="co">#&gt;   677     12       1    0.244  0.0641        0.146        0.409</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="va">bmt.cox</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call: survfit(formula = bmt.cox)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;        n events median 0.95LCL 0.95UCL</span></span>
<span><span class="co">#&gt; [1,] 137     83    422     268      NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="va">bmt.cox</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call: survfit(formula = bmt.cox, newdata = tibble(group = unique(bmt$group)))</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     n events median 0.95LCL 0.95UCL</span></span>
<span><span class="co">#&gt; 1 137     83    422     268      NA</span></span>
<span><span class="co">#&gt; 2 137     83     NA     625      NA</span></span>
<span><span class="co">#&gt; 3 137     83    268     162     467</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt.cox</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call: survfit(formula = bmt.cox, newdata = tibble(group = unique(bmt$group)))</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  time n.risk n.event survival1 survival2 survival3</span></span>
<span><span class="co">#&gt;     1    137       1     0.993     0.996     0.989</span></span>
<span><span class="co">#&gt;     2    136       1     0.985     0.992     0.978</span></span>
<span><span class="co">#&gt;    10    135       1     0.978     0.987     0.968</span></span>
<span><span class="co">#&gt;    16    134       1     0.970     0.983     0.957</span></span>
<span><span class="co">#&gt;    32    133       1     0.963     0.979     0.946</span></span>
<span><span class="co">#&gt;    35    132       1     0.955     0.975     0.935</span></span>
<span><span class="co">#&gt;    47    131       2     0.941     0.966     0.914</span></span>
<span><span class="co">#&gt;    48    129       2     0.926     0.957     0.893</span></span>
<span><span class="co">#&gt;    53    127       1     0.918     0.953     0.882</span></span>
<span><span class="co">#&gt;    55    126       1     0.911     0.949     0.872</span></span>
<span><span class="co">#&gt;    63    125       1     0.903     0.944     0.861</span></span>
<span><span class="co">#&gt;    64    124       1     0.896     0.940     0.851</span></span>
<span><span class="co">#&gt;    74    123       2     0.881     0.931     0.830</span></span>
<span><span class="co">#&gt;    76    121       1     0.873     0.926     0.819</span></span>
<span><span class="co">#&gt;    79    120       1     0.865     0.922     0.809</span></span>
<span><span class="co">#&gt;    80    119       2     0.850     0.913     0.788</span></span>
<span><span class="co">#&gt;    84    117       1     0.843     0.908     0.778</span></span>
<span><span class="co">#&gt;    86    116       1     0.835     0.903     0.768</span></span>
<span><span class="co">#&gt;    93    115       1     0.827     0.899     0.757</span></span>
<span><span class="co">#&gt;   100    114       1     0.820     0.894     0.747</span></span>
<span><span class="co">#&gt;   104    113       1     0.812     0.889     0.737</span></span>
<span><span class="co">#&gt;   105    112       2     0.797     0.880     0.717</span></span>
<span><span class="co">#&gt;   107    110       1     0.789     0.875     0.707</span></span>
<span><span class="co">#&gt;   109    109       1     0.782     0.870     0.697</span></span>
<span><span class="co">#&gt;   110    108       1     0.774     0.866     0.687</span></span>
<span><span class="co">#&gt;   113    107       1     0.766     0.861     0.677</span></span>
<span><span class="co">#&gt;   115    106       1     0.759     0.856     0.667</span></span>
<span><span class="co">#&gt;   120    105       1     0.751     0.851     0.657</span></span>
<span><span class="co">#&gt;   122    104       2     0.735     0.841     0.637</span></span>
<span><span class="co">#&gt;   129    102       1     0.727     0.836     0.627</span></span>
<span><span class="co">#&gt;   157    101       1     0.720     0.831     0.617</span></span>
<span><span class="co">#&gt;   162    100       1     0.712     0.826     0.607</span></span>
<span><span class="co">#&gt;   164     99       1     0.704     0.821     0.598</span></span>
<span><span class="co">#&gt;   168     98       1     0.696     0.815     0.588</span></span>
<span><span class="co">#&gt;   172     97       1     0.688     0.810     0.578</span></span>
<span><span class="co">#&gt;   183     96       1     0.680     0.805     0.568</span></span>
<span><span class="co">#&gt;   192     95       1     0.672     0.800     0.558</span></span>
<span><span class="co">#&gt;   194     94       1     0.664     0.794     0.549</span></span>
<span><span class="co">#&gt;   211     93       1     0.656     0.789     0.539</span></span>
<span><span class="co">#&gt;   219     92       1     0.648     0.783     0.530</span></span>
<span><span class="co">#&gt;   230     90       1     0.640     0.778     0.520</span></span>
<span><span class="co">#&gt;   242     89       1     0.632     0.773     0.511</span></span>
<span><span class="co">#&gt;   248     88       1     0.624     0.767     0.501</span></span>
<span><span class="co">#&gt;   268     87       1     0.616     0.761     0.492</span></span>
<span><span class="co">#&gt;   272     86       1     0.608     0.756     0.482</span></span>
<span><span class="co">#&gt;   273     85       1     0.600     0.750     0.473</span></span>
<span><span class="co">#&gt;   276     84       1     0.592     0.745     0.464</span></span>
<span><span class="co">#&gt;   288     83       1     0.584     0.739     0.454</span></span>
<span><span class="co">#&gt;   318     82       1     0.576     0.733     0.445</span></span>
<span><span class="co">#&gt;   332     81       1     0.568     0.727     0.436</span></span>
<span><span class="co">#&gt;   363     80       1     0.560     0.722     0.427</span></span>
<span><span class="co">#&gt;   381     79       1     0.552     0.716     0.418</span></span>
<span><span class="co">#&gt;   383     78       1     0.544     0.710     0.409</span></span>
<span><span class="co">#&gt;   390     77       2     0.528     0.698     0.392</span></span>
<span><span class="co">#&gt;   414     75       1     0.520     0.692     0.383</span></span>
<span><span class="co">#&gt;   418     74       1     0.512     0.686     0.374</span></span>
<span><span class="co">#&gt;   421     73       1     0.504     0.680     0.366</span></span>
<span><span class="co">#&gt;   422     72       1     0.496     0.674     0.357</span></span>
<span><span class="co">#&gt;   456     71       1     0.488     0.667     0.349</span></span>
<span><span class="co">#&gt;   466     70       1     0.480     0.661     0.340</span></span>
<span><span class="co">#&gt;   467     69       1     0.472     0.655     0.332</span></span>
<span><span class="co">#&gt;   481     68       1     0.464     0.649     0.324</span></span>
<span><span class="co">#&gt;   486     67       1     0.455     0.642     0.315</span></span>
<span><span class="co">#&gt;   487     66       1     0.447     0.636     0.307</span></span>
<span><span class="co">#&gt;   526     65       1     0.439     0.629     0.299</span></span>
<span><span class="co">#&gt;   606     63       1     0.431     0.623     0.291</span></span>
<span><span class="co">#&gt;   609     62       1     0.423     0.616     0.283</span></span>
<span><span class="co">#&gt;   625     61       1     0.415     0.609     0.275</span></span>
<span><span class="co">#&gt;   641     60       1     0.407     0.603     0.267</span></span>
<span><span class="co">#&gt;   662     59       1     0.399     0.596     0.260</span></span>
<span><span class="co">#&gt;   677     58       1     0.391     0.589     0.252</span></span>
<span><span class="co">#&gt;   704     57       1     0.383     0.582     0.244</span></span>
<span><span class="co">#&gt;   748     56       1     0.374     0.575     0.237</span></span>
<span><span class="co">#&gt;  1063     47       1     0.365     0.567     0.228</span></span>
<span><span class="co">#&gt;  1074     46       1     0.356     0.559     0.220</span></span>
<span><span class="co">#&gt;  2204      9       1     0.313     0.520     0.182</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="adjustment-for-ties-optional" class="level2" data-number="6.3"><h2 data-number="6.3" class="anchored" data-anchor-id="adjustment-for-ties-optional">
<span class="header-section-number">6.3</span> Adjustment for Ties (optional)</h2>
<section id="section" class="level3" data-number="6.3.1"><h3 data-number="6.3.1" class="anchored" data-anchor-id="section">
<span class="header-section-number">6.3.1</span> </h3>
<p>At each time <span class="math inline">\(t_i\)</span> at which more than one of the subjects has an event, let <span class="math inline">\(d_i\)</span> be the number of events at that time, <span class="math inline">\(D_i\)</span> the set of subjects with events at that time, and let <span class="math inline">\(s_i\)</span> be a covariate vector for an artificial subject obtained by adding up the covariate values for the subjects with an event at time <span class="math inline">\(t_i\)</span>. Let <span class="math display">\[\bar\eta_i = \beta_1s_{i1}+\cdots+\beta_ps_{ip}\]</span> and <span class="math inline">\(\bar\theta_i = \text{exp}\left\{\bar\eta_i\right\}\)</span>.</p>
<p>Let <span class="math inline">\(s_i\)</span> be a covariate vector for an artificial subject obtained by adding up the covariate values for the subjects with an event at time <span class="math inline">\(t_i\)</span>. Note that</p>
<p><span class="math display">\[
\begin{aligned}
\bar\eta_i &amp;=\sum_{j \in D_i}\beta_1x_{j1}+\cdots+\beta_px_{jp}\\
&amp;= \beta_1s_{i1}+\cdots+\beta_ps_{ip}\\
\bar\theta_i &amp;= \text{exp}\left\{\bar\eta_i\right\}\\
&amp;= \prod_{j \in D_i}\theta_i
\end{aligned}
\]</span></p>
<section id="breslows-method-for-ties" class="level4"><h4 class="anchored" data-anchor-id="breslows-method-for-ties">Breslow’s method for ties</h4>
<p>Breslow’s method estimates the partial likelihood as</p>
<p><span class="math display">\[
\begin{aligned}
L(\beta|T) &amp;=
\prod_i \frac{\bar\theta_i}{[\sum_{k \in R(t_i)} \theta_k]^{d_i}}\\
&amp;= \prod_i \prod_{j \in D_i}\frac{\theta_j}{\sum_{k \in R(t_i)} \theta_k}
\end{aligned}
\]</span></p>
<p>This method is equivalent to treating each event as distinct and using the non-ties formula. It works best when the number of ties is small. It is the default in many statistical packages, including PROC PHREG in SAS.</p>
</section><section id="efrons-method-for-ties" class="level4"><h4 class="anchored" data-anchor-id="efrons-method-for-ties">Efron’s method for ties</h4>
<p>The other common method is Efron’s, which is the default in R.</p>
<p><span class="math display">\[L(\beta|T)=
\prod_i \frac{\bar\theta_i}{\prod_{j=1}^{d_i}[\sum_{k \in R(t_i)} \theta_k-\frac{j-1}{d_i}\sum_{k \in D_i} \theta_k]}\]</span> This is closer to the exact discrete partial likelihood when there are many ties.</p>
<p>The third option in R (and an option also in SAS as <code>discrete</code>) is the “exact” method, which is the same one used for matched logistic regression.</p>
</section><section id="example-breslows-method" class="level4"><h4 class="anchored" data-anchor-id="example-breslows-method">Example: Breslow’s method</h4>
<p>Suppose as an example we have a time <span class="math inline">\(t\)</span> where there are 20 individuals at risk and three failures. Let the three individuals have risk parameters <span class="math inline">\(\theta_1, \theta_2, \theta_3\)</span> and let the sum of the risk parameters of the remaining 17 individuals be <span class="math inline">\(\theta_R\)</span>. Then the factor in the partial likelihood at time <span class="math inline">\(t\)</span> using Breslow’s method is</p>
<div class="smaller">
<p><span class="math display">\[
\left(\frac{\theta_1}{\theta_R+\theta_1+\theta_2+\theta_3}\right)
\left(\frac{\theta_2}{\theta_R+\theta_1+\theta_2+\theta_3}\right)
\left(\frac{\theta_3}{\theta_R+\theta_1+\theta_2+\theta_3}\right)
\]</span></p>
</div>
<p>If on the other hand, they had died in the order 1,2, 3, then the contribution to the partial likelihood would be:</p>
<div class="smaller">
<p><span class="math display">\[
\left(\frac{\theta_1}{\theta_R+\theta_1+\theta_2+\theta_3}\right)
\left(\frac{\theta_2}{\theta_R+\theta_2+\theta_3}\right)
\left(\frac{\theta_3}{\theta_R+\theta_3}\right)
\]</span></p>
</div>
<p>as the risk set got smaller with each failure. The exact method roughly averages the results for the six possible orderings of the failures.</p>
</section><section id="example-efrons-method" class="level4"><h4 class="anchored" data-anchor-id="example-efrons-method">Example: Efron’s method</h4>
<p>But we don’t know the order they failed in, so instead of reducing the denominator by one risk coefficient each time, we reduce it by the same fraction. This is Efron’s method.</p>
<div class="smaller">
<p><span class="math display">\[\left(\frac{\theta_1}{\theta_R+\theta_1+\theta_2+\theta_3}\right)
\left(\frac{\theta_2}{\theta_R+2(\theta_1+\theta_2+\theta_3)/3}\right)
\left(\frac{\theta_3}{\theta_R+(\theta_1+\theta_2+\theta_3)/3}\right)\]</span></p>
</div>


<!-- -->

</section></section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./intro-to-survival-analysis.html" class="pagination-link" aria-label="Introduction to Survival Analysis">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Introduction to Survival Analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./coxph-model-building.html" class="pagination-link" aria-label="Building Cox Proportional Hazards models">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Building Cox Proportional Hazards models</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb14" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Proportional Hazards Models</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>{{&lt; include shared-config.qmd &gt;}}</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="fu">## The proportional hazards model</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="fu">### Background on the Proportional Hazards Model</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>The exponential distribution has constant hazard:</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>f(t) &amp;= \lambda e^{-\lambda t}<span class="sc">\\</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>S(t) &amp;= e^{-\lambda t}<span class="sc">\\</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>h(t) &amp;= \lambda</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>Let's make two generalizations. First, we let the hazard depend on some</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>covariates $x_1,x_2, \dots, x_p$; we will indicate this dependence by extending our notation for hazard:</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>$$h(t|\boldsymbol x) \eqdef p(T=t|T\ge t, \boldsymbol X = \boldsymbol x)$$</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>Second, we let the base hazard depend on $t$, but not on the covariates (for now). We can do this using either parametric or semi-parametric approaches.</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cox's Proportional Hazards Model</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>The generalization is that the hazard function is </span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>h(t|x)&amp;= h_0(t)\theta(x)<span class="sc">\\</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>\theta(x) &amp;= \exp{\eta(x)}<span class="sc">\\</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>\eta(x) &amp;= x'\beta<span class="sc">\\</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>&amp;\eqdef \beta_1x_1+\cdots+\beta_px_p</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>The relationship between $h(t|x)$ and $\eta(x)$ has a log link (that is, $\log{h(t|x)} = \log{h_0(t)} + \eta(x)$), as in a generalized linear model.</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>This model is **semi-parametric**, because the linear predictor depends on estimated</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>parameters but the base hazard function is unspecified. </span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>There is no constant term in $\eta(x)$, because it is absorbed in the base hazard. </span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>Alternatively, we could define $\beta_0(t) = \log{h_0(t)}$, and then $\eta(x,t) = \beta_0(t) + \beta_1x_1+\cdots+\beta_px_p$.</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>For two different individuals with covariate patterns $\boldsymbol x_1$ and $\boldsymbol x_2$, the ratio of the hazard functions (a.k.a. **hazard ratio**, a.k.a. **relative hazard**) is:</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>&amp;=\frac{h_0(t)\theta(\boldsymbol x_1)}{h_0(t)\theta(\boldsymbol x_2)}<span class="sc">\\</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>&amp;=\frac{\theta(\boldsymbol x_1)}{\theta(\boldsymbol x_2)}<span class="sc">\\</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>Under the proportional hazards model, this ratio (a.k.a. proportion) does not depend on $t$. This property is a structural limitation of the model; it is called the **proportional hazards assumption**.</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>::: {#def-pha}</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a><span class="fu">### proportional hazards</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>A conditional probability distribution $p(T|X)$ has **proportional hazards** if the hazard ratio $h(t|\boldsymbol x_1)/h(t|\boldsymbol x_2)$ does not depend on $t$. Mathematically, it can be written as:</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>= \theta(\boldsymbol x_1,\boldsymbol x_2)</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>As we saw above, Cox's proportional hazards model has this property, with $\theta(\boldsymbol x_1,\boldsymbol x_2) = \frac{\theta(\boldsymbol x_1)}{\theta(\boldsymbol x_2)}$.</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>We are using two similar notations, $\theta(\boldsymbol x_1,\boldsymbol x_2)$ and $\theta(\boldsymbol x)$. We can link these notations if we define $\theta(\boldsymbol x) \eqdef \theta(\boldsymbol x, \boldsymbol 0)$ and $\theta(\boldsymbol 0) = 1$.</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>It also has additional notable properties:</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>&amp;=\frac{\theta(\boldsymbol x_1)}{\theta(\boldsymbol x_2)}<span class="sc">\\</span></span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>&amp;=\frac{\exp{\eta(\boldsymbol x_1)}}{\exp{\eta(\boldsymbol x_2)}}<span class="sc">\\</span></span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>&amp;=\exp{\eta(\boldsymbol x_1)-\eta(\boldsymbol x_2)}<span class="sc">\\</span></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>&amp;=\exp{\boldsymbol x_1'\beta-\boldsymbol x_2'\beta}<span class="sc">\\</span></span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>&amp;=\exp{(\boldsymbol x_1 - \boldsymbol x_2)'\beta}<span class="sc">\\</span></span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>Hence on the log scale, we have:</span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>\log{\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}}</span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>&amp;=\eta(\boldsymbol x_1)-\eta(\boldsymbol x_2)<span class="sc">\\</span></span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>&amp;= \boldsymbol x_1'\beta-\boldsymbol x_2'\beta<span class="sc">\\</span></span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>&amp;= (\boldsymbol x_1 - \boldsymbol x_2)'\beta</span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>If only one covariate $x_j$ is changing, then:</span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>\log{\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}} </span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a>&amp;=  (x_{1j} - x_{2j}) \cdot \beta_j<span class="sc">\\</span></span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a>&amp;\propto (x_{1j} - x_{2j})</span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a>That is, under Cox's model $h(t|\boldsymbol x) = h_0(t)\exp{\boldsymbol x'\beta}$, the log of the hazard ratio is proportional to the difference in $x_j$, with the proportionality coefficient equal to $\beta_j$.</span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a>Further,</span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>\log{h(t|\boldsymbol x)}</span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a>&amp;=\log{h_0(t)}  + x'\beta</span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a>That is, the covariate effects are additive on the log-hazard scale.</span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a>See also: </span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a><span class="ot">&lt;https://en.wikipedia.org/wiki/Proportional_hazards_model#Why_it_is_called_%22proportional%22&gt;</span></span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a><span class="fu">### Additional properties of the proportional hazards model</span></span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a>If $h(t|x)= h_0(t)\theta(x)$, then:</span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Cumulative hazards are also proportional to $H_0(t)$</span></span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>H(t|x)</span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a>&amp;\eqdef \int_{u=0}^t h(u)du<span class="sc">\\</span></span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a>&amp;= \int_{u=0}^t h_0(u)\theta(x)du<span class="sc">\\</span></span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a>&amp;= \theta(x)\int_{u=0}^t h_0(u)du<span class="sc">\\</span></span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>&amp;= \theta(x)H_0(t)</span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a>where $H_0(t) \eqdef H(t|0) = \int_{u=0}^t h_0(u)du$.</span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Survival functions are exponential multiples of $S_0(t)$</span></span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>S(t|x)</span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a>&amp;= \exp{-H(t|x)}<span class="sc">\\</span></span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>&amp;= \exp{-\theta(x)\cdot H_0(t)}<span class="sc">\\</span></span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a>&amp;= \left(\exp{- H_0(t)}\right)^{\theta(x)}<span class="sc">\\</span></span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a>&amp;= \left(S_0(t)\right)^{\theta(x)}<span class="sc">\\</span></span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a>where $S_0(t) \eqdef P(T\ge t | \boldsymbol X = 0)$ is the survival function for an individual whose covariates are all equal to their default values.</span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a><span class="fu">### Testing the proportional hazards assumption</span></span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a>The Nelson-Aalen estimate of the cumulative hazard is usually used for estimates of the hazard and often the cumulative hazard.</span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a>If the hazards of the three groups are proportional, that means that the ratio of the hazards is constant over $t$. We can test this using the ratios of the estimated cumulative hazards, which also would be</span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a>proportional, as shown above.</span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(KMsurv)</span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(bmt)</span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a>bmt <span class="ot">=</span> </span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a>  bmt <span class="sc">|&gt;</span> </span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb14-181"><a href="#cb14-181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-182"><a href="#cb14-182" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> </span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a>      group <span class="sc">|&gt;</span> </span>
<span id="cb14-184"><a href="#cb14-184" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb14-185"><a href="#cb14-185" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"ALL"</span>,<span class="st">"Low Risk AML"</span>,<span class="st">"High Risk AML"</span>)))</span>
<span id="cb14-186"><a href="#cb14-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-187"><a href="#cb14-187" aria-hidden="true" tabindex="-1"></a>nafit <span class="ot">=</span> <span class="fu">survfit</span>(</span>
<span id="cb14-188"><a href="#cb14-188" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> <span class="fu">Surv</span>(t2,d3) <span class="sc">~</span> group,</span>
<span id="cb14-189"><a href="#cb14-189" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"fleming-harrington"</span>,</span>
<span id="cb14-190"><a href="#cb14-190" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> bmt)</span>
<span id="cb14-191"><a href="#cb14-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-192"><a href="#cb14-192" aria-hidden="true" tabindex="-1"></a>bmt_curves <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">timevec =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>)</span>
<span id="cb14-193"><a href="#cb14-193" aria-hidden="true" tabindex="-1"></a>sf1 <span class="ot">&lt;-</span> <span class="fu">with</span>(nafit[<span class="dv">1</span>], <span class="fu">stepfun</span>(time,<span class="fu">c</span>(<span class="dv">1</span>,surv)))</span>
<span id="cb14-194"><a href="#cb14-194" aria-hidden="true" tabindex="-1"></a>sf2 <span class="ot">&lt;-</span> <span class="fu">with</span>(nafit[<span class="dv">2</span>], <span class="fu">stepfun</span>(time,<span class="fu">c</span>(<span class="dv">1</span>,surv)))</span>
<span id="cb14-195"><a href="#cb14-195" aria-hidden="true" tabindex="-1"></a>sf3 <span class="ot">&lt;-</span> <span class="fu">with</span>(nafit[<span class="dv">3</span>], <span class="fu">stepfun</span>(time,<span class="fu">c</span>(<span class="dv">1</span>,surv)))</span>
<span id="cb14-196"><a href="#cb14-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-197"><a href="#cb14-197" aria-hidden="true" tabindex="-1"></a>bmt_curves <span class="ot">=</span> </span>
<span id="cb14-198"><a href="#cb14-198" aria-hidden="true" tabindex="-1"></a>  bmt_curves <span class="sc">|&gt;</span> </span>
<span id="cb14-199"><a href="#cb14-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-200"><a href="#cb14-200" aria-hidden="true" tabindex="-1"></a>    <span class="at">cumhaz1 =</span> <span class="sc">-</span><span class="fu">log</span>(<span class="fu">sf1</span>(timevec)),</span>
<span id="cb14-201"><a href="#cb14-201" aria-hidden="true" tabindex="-1"></a>    <span class="at">cumhaz2 =</span> <span class="sc">-</span><span class="fu">log</span>(<span class="fu">sf2</span>(timevec)),</span>
<span id="cb14-202"><a href="#cb14-202" aria-hidden="true" tabindex="-1"></a>    <span class="at">cumhaz3 =</span> <span class="sc">-</span><span class="fu">log</span>(<span class="fu">sf3</span>(timevec)))</span>
<span id="cb14-203"><a href="#cb14-203" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-204"><a href="#cb14-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-207"><a href="#cb14-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-208"><a href="#cb14-208" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Hazard Ratios by Disease Group"</span></span>
<span id="cb14-209"><a href="#cb14-209" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb14-210"><a href="#cb14-210" aria-hidden="true" tabindex="-1"></a>bmt_rel_hazard_plot <span class="ot">=</span> </span>
<span id="cb14-211"><a href="#cb14-211" aria-hidden="true" tabindex="-1"></a>  bmt_curves <span class="sc">|&gt;</span> </span>
<span id="cb14-212"><a href="#cb14-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb14-213"><a href="#cb14-213" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb14-214"><a href="#cb14-214" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> timevec,</span>
<span id="cb14-215"><a href="#cb14-215" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> cumhaz1<span class="sc">/</span>cumhaz2)</span>
<span id="cb14-216"><a href="#cb14-216" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb14-217"><a href="#cb14-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"ALL/Low Risk AML"</span>)) <span class="sc">+</span> </span>
<span id="cb14-218"><a href="#cb14-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Hazard Ratio"</span>) <span class="sc">+</span></span>
<span id="cb14-219"><a href="#cb14-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time"</span>) <span class="sc">+</span> </span>
<span id="cb14-220"><a href="#cb14-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb14-221"><a href="#cb14-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> cumhaz3<span class="sc">/</span>cumhaz1, <span class="at">col =</span> <span class="st">"High Risk AML/ALL"</span>)) <span class="sc">+</span></span>
<span id="cb14-222"><a href="#cb14-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> cumhaz3<span class="sc">/</span>cumhaz2, <span class="at">col =</span> <span class="st">"High Risk AML/Low Risk AML"</span>)) <span class="sc">+</span></span>
<span id="cb14-223"><a href="#cb14-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb14-224"><a href="#cb14-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">colour =</span> <span class="st">"Comparison"</span>) <span class="sc">+</span></span>
<span id="cb14-225"><a href="#cb14-225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>)</span>
<span id="cb14-226"><a href="#cb14-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-227"><a href="#cb14-227" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(bmt_rel_hazard_plot)</span>
<span id="cb14-228"><a href="#cb14-228" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-229"><a href="#cb14-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-230"><a href="#cb14-230" aria-hidden="true" tabindex="-1"></a>We can zoom in on 30-300 days to take a closer look:</span>
<span id="cb14-231"><a href="#cb14-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-234"><a href="#cb14-234" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-235"><a href="#cb14-235" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Hazard Ratios by Disease Group (30-300 Days)"</span></span>
<span id="cb14-236"><a href="#cb14-236" aria-hidden="true" tabindex="-1"></a>bmt_rel_hazard_plot <span class="sc">+</span> <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">30</span>,<span class="dv">300</span>))</span>
<span id="cb14-237"><a href="#cb14-237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-238"><a href="#cb14-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-239"><a href="#cb14-239" aria-hidden="true" tabindex="-1"></a><span class="fu">### Smoothed hazard functions</span></span>
<span id="cb14-240"><a href="#cb14-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-241"><a href="#cb14-241" aria-hidden="true" tabindex="-1"></a>The Nelson-Aalen estimate of the cumulative hazard is usually used for</span>
<span id="cb14-242"><a href="#cb14-242" aria-hidden="true" tabindex="-1"></a>estimates of the hazard. Since the hazard is the derivative of the</span>
<span id="cb14-243"><a href="#cb14-243" aria-hidden="true" tabindex="-1"></a>cumulative hazard, we need a smooth estimate of the cumulative hazard,</span>
<span id="cb14-244"><a href="#cb14-244" aria-hidden="true" tabindex="-1"></a>which is provided by smoothing the step-function cumulative hazard.</span>
<span id="cb14-245"><a href="#cb14-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-246"><a href="#cb14-246" aria-hidden="true" tabindex="-1"></a>The R package <span class="in">`muhaz`</span> handles this for us. What we are looking for is</span>
<span id="cb14-247"><a href="#cb14-247" aria-hidden="true" tabindex="-1"></a>whether the hazard function is more or less the same shape, increasing,</span>
<span id="cb14-248"><a href="#cb14-248" aria-hidden="true" tabindex="-1"></a>decreasing, constant, etc. Are the hazards "proportional"?</span>
<span id="cb14-249"><a href="#cb14-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-252"><a href="#cb14-252" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-253"><a href="#cb14-253" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Disease-Free Cumulative Hazard by Disease Group"</span></span>
<span id="cb14-254"><a href="#cb14-254" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb14-255"><a href="#cb14-255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">survfit</span>(<span class="fu">Surv</span>(t2,d3)<span class="sc">~</span>group,<span class="at">data=</span>bmt),</span>
<span id="cb14-256"><a href="#cb14-256" aria-hidden="true" tabindex="-1"></a>  <span class="at">col=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,</span>
<span id="cb14-257"><a href="#cb14-257" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd=</span><span class="dv">2</span>,</span>
<span id="cb14-258"><a href="#cb14-258" aria-hidden="true" tabindex="-1"></a>  <span class="at">fun=</span><span class="st">"cumhaz"</span>,</span>
<span id="cb14-259"><a href="#cb14-259" aria-hidden="true" tabindex="-1"></a>  <span class="at">mark.time =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-260"><a href="#cb14-260" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomright"</span>,<span class="fu">c</span>(<span class="st">"ALL"</span>,<span class="st">"Low Risk AML"</span>,<span class="st">"High Risk AML"</span>),<span class="at">col=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb14-261"><a href="#cb14-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-262"><a href="#cb14-262" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-263"><a href="#cb14-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-266"><a href="#cb14-266" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-267"><a href="#cb14-267" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Smoothed Hazard Rate Estimates by Disease Group"</span></span>
<span id="cb14-268"><a href="#cb14-268" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(muhaz)</span>
<span id="cb14-269"><a href="#cb14-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-270"><a href="#cb14-270" aria-hidden="true" tabindex="-1"></a><span class="fu">muhaz</span>(bmt<span class="sc">$</span>t2,bmt<span class="sc">$</span>d3,bmt<span class="sc">$</span>group<span class="sc">==</span><span class="st">"High Risk AML"</span>) <span class="sc">|&gt;</span> <span class="fu">plot</span>(<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">col=</span><span class="dv">3</span>)</span>
<span id="cb14-271"><a href="#cb14-271" aria-hidden="true" tabindex="-1"></a><span class="fu">muhaz</span>(bmt<span class="sc">$</span>t2,bmt<span class="sc">$</span>d3,bmt<span class="sc">$</span>group<span class="sc">==</span><span class="st">"ALL"</span>) <span class="sc">|&gt;</span> <span class="fu">lines</span>(<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">col=</span><span class="dv">1</span>)</span>
<span id="cb14-272"><a href="#cb14-272" aria-hidden="true" tabindex="-1"></a><span class="fu">muhaz</span>(bmt<span class="sc">$</span>t2,bmt<span class="sc">$</span>d3,bmt<span class="sc">$</span>group<span class="sc">==</span><span class="st">"Low Risk AML"</span>) <span class="sc">|&gt;</span> <span class="fu">lines</span>(<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb14-273"><a href="#cb14-273" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>,<span class="fu">c</span>(<span class="st">"ALL"</span>,<span class="st">"Low Risk AML"</span>,<span class="st">"High Risk AML"</span>),<span class="at">col=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb14-274"><a href="#cb14-274" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-275"><a href="#cb14-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-276"><a href="#cb14-276" aria-hidden="true" tabindex="-1"></a>Group 3 was plotted first because it has the highest hazard.</span>
<span id="cb14-277"><a href="#cb14-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-278"><a href="#cb14-278" aria-hidden="true" tabindex="-1"></a>We will see that except for an initial blip in the high risk AML group,</span>
<span id="cb14-279"><a href="#cb14-279" aria-hidden="true" tabindex="-1"></a>the hazards look roughly proportional . They are all strongly</span>
<span id="cb14-280"><a href="#cb14-280" aria-hidden="true" tabindex="-1"></a>decreasing.</span>
<span id="cb14-281"><a href="#cb14-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-282"><a href="#cb14-282" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fitting the Proportional Hazards Model</span></span>
<span id="cb14-283"><a href="#cb14-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-284"><a href="#cb14-284" aria-hidden="true" tabindex="-1"></a>How do we fit a proportional hazards regression model? We need to</span>
<span id="cb14-285"><a href="#cb14-285" aria-hidden="true" tabindex="-1"></a>estimate the coefficients of the covariates, and we need to estimate the</span>
<span id="cb14-286"><a href="#cb14-286" aria-hidden="true" tabindex="-1"></a>base hazard $h_0(t)$. For the covariates, supposing for simplicity that</span>
<span id="cb14-287"><a href="#cb14-287" aria-hidden="true" tabindex="-1"></a>there are no tied event times, let the event times for the whole data</span>
<span id="cb14-288"><a href="#cb14-288" aria-hidden="true" tabindex="-1"></a>set be $t_1, t_2,\ldots,t_D$. Let the risk set at time $t_i$ be $R(t_i)$</span>
<span id="cb14-289"><a href="#cb14-289" aria-hidden="true" tabindex="-1"></a>and </span>
<span id="cb14-290"><a href="#cb14-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-291"><a href="#cb14-291" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-292"><a href="#cb14-292" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb14-293"><a href="#cb14-293" aria-hidden="true" tabindex="-1"></a>\eta(\boldsymbol{x}) &amp;= \beta_1x_{1}+\cdots+\beta_p x_{p}<span class="sc">\\</span></span>
<span id="cb14-294"><a href="#cb14-294" aria-hidden="true" tabindex="-1"></a>\theta(\boldsymbol{x}) &amp;= e^{\eta(\boldsymbol{x})}<span class="sc">\\</span></span>
<span id="cb14-295"><a href="#cb14-295" aria-hidden="true" tabindex="-1"></a>h(t|X=x)&amp;= h_0(t)e^{\eta(\boldsymbol{x})}=\theta(\boldsymbol{x}) h_0(t)</span>
<span id="cb14-296"><a href="#cb14-296" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb14-297"><a href="#cb14-297" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-298"><a href="#cb14-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-299"><a href="#cb14-299" aria-hidden="true" tabindex="-1"></a>Conditional on a single failure at time $t$, the probability that the</span>
<span id="cb14-300"><a href="#cb14-300" aria-hidden="true" tabindex="-1"></a>event is due to subject $f\in R(t)$ is approximately</span>
<span id="cb14-301"><a href="#cb14-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-302"><a href="#cb14-302" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-303"><a href="#cb14-303" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb14-304"><a href="#cb14-304" aria-hidden="true" tabindex="-1"></a>\Pr(f \text{ fails}|\text{1 failure at } t) </span>
<span id="cb14-305"><a href="#cb14-305" aria-hidden="true" tabindex="-1"></a>&amp;= \frac{h_0(t)e^{\eta(\boldsymbol{x}_f)}}{\sum_{k \in R(t)}h_0(t)e^{\eta(\boldsymbol{x}_f)}}<span class="sc">\\</span></span>
<span id="cb14-306"><a href="#cb14-306" aria-hidden="true" tabindex="-1"></a>&amp;=\frac{\theta(\boldsymbol{x}_f)}{\sum_{k \in R(t)} \theta(\boldsymbol{x}_k)}</span>
<span id="cb14-307"><a href="#cb14-307" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb14-308"><a href="#cb14-308" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb14-309"><a href="#cb14-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-310"><a href="#cb14-310" aria-hidden="true" tabindex="-1"></a>The logic behind this has several steps. We first fix (ex post) the</span>
<span id="cb14-311"><a href="#cb14-311" aria-hidden="true" tabindex="-1"></a>failure times and note that in this discrete context, the probability</span>
<span id="cb14-312"><a href="#cb14-312" aria-hidden="true" tabindex="-1"></a>$p_j$ that a subject $j$ in the risk set fails at time $t$ is just the</span>
<span id="cb14-313"><a href="#cb14-313" aria-hidden="true" tabindex="-1"></a>hazard of that subject at that time.</span>
<span id="cb14-314"><a href="#cb14-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-315"><a href="#cb14-315" aria-hidden="true" tabindex="-1"></a>If all of the $p_j$ are small, the chance that exactly one subject fails</span>
<span id="cb14-316"><a href="#cb14-316" aria-hidden="true" tabindex="-1"></a>is</span>
<span id="cb14-317"><a href="#cb14-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-318"><a href="#cb14-318" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-319"><a href="#cb14-319" aria-hidden="true" tabindex="-1"></a>\sum_{k\in R(t)}p_k\left<span class="co">[</span><span class="ot">\prod_{m\in R(t), m\ne k} (1-p_m)\right</span><span class="co">]</span>\approx\sum_{k\in R(t)}p_k</span>
<span id="cb14-320"><a href="#cb14-320" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-321"><a href="#cb14-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-322"><a href="#cb14-322" aria-hidden="true" tabindex="-1"></a>If subject $i$ is the one who experiences the event of interest at time</span>
<span id="cb14-323"><a href="#cb14-323" aria-hidden="true" tabindex="-1"></a>$t_i$, then the **partial likelihood** is</span>
<span id="cb14-324"><a href="#cb14-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-325"><a href="#cb14-325" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-326"><a href="#cb14-326" aria-hidden="true" tabindex="-1"></a>\mathcal L^*(\beta|T)=</span>
<span id="cb14-327"><a href="#cb14-327" aria-hidden="true" tabindex="-1"></a>\prod_i \frac{\theta(x_i)}{\sum_{k \in R(t_i)} \theta(\boldsymbol{x}_k)}</span>
<span id="cb14-328"><a href="#cb14-328" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-329"><a href="#cb14-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-330"><a href="#cb14-330" aria-hidden="true" tabindex="-1"></a>and we can numerically maximize this with respect to the coefficients</span>
<span id="cb14-331"><a href="#cb14-331" aria-hidden="true" tabindex="-1"></a>$\boldsymbol{\beta}$ that specify</span>
<span id="cb14-332"><a href="#cb14-332" aria-hidden="true" tabindex="-1"></a>$\eta(\boldsymbol{x}) = \boldsymbol{x}'\boldsymbol{\beta}$. When there</span>
<span id="cb14-333"><a href="#cb14-333" aria-hidden="true" tabindex="-1"></a>are tied event times adjustments need to be made, but the likelihood is</span>
<span id="cb14-334"><a href="#cb14-334" aria-hidden="true" tabindex="-1"></a>still similar. Note that we don't need to know the base hazard to solve</span>
<span id="cb14-335"><a href="#cb14-335" aria-hidden="true" tabindex="-1"></a>for the coefficients.</span>
<span id="cb14-336"><a href="#cb14-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-337"><a href="#cb14-337" aria-hidden="true" tabindex="-1"></a>Once we have coefficient estimates</span>
<span id="cb14-338"><a href="#cb14-338" aria-hidden="true" tabindex="-1"></a>$\hat{\boldsymbol{\beta}} =(\hat \beta_1,\ldots,\hat\beta_p)$, this also</span>
<span id="cb14-339"><a href="#cb14-339" aria-hidden="true" tabindex="-1"></a>defines $\hat\eta(x)$ and $\hat\theta(x)$ and then the estimated base</span>
<span id="cb14-340"><a href="#cb14-340" aria-hidden="true" tabindex="-1"></a>cumulative hazard function is $$\hat H(t)=</span>
<span id="cb14-341"><a href="#cb14-341" aria-hidden="true" tabindex="-1"></a>\sum_{t_i &lt; t} \frac{d_i}{\sum_{k\in R(t_i)} \theta(x_k)}$$ which</span>
<span id="cb14-342"><a href="#cb14-342" aria-hidden="true" tabindex="-1"></a>reduces to the Nelson-Aalen estimate when there are no covariates. There</span>
<span id="cb14-343"><a href="#cb14-343" aria-hidden="true" tabindex="-1"></a>are numerous other estimates that have been proposed as well.</span>
<span id="cb14-344"><a href="#cb14-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-345"><a href="#cb14-345" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cox Model for the `bmt` data</span></span>
<span id="cb14-346"><a href="#cb14-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-347"><a href="#cb14-347" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fit the model</span></span>
<span id="cb14-348"><a href="#cb14-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-351"><a href="#cb14-351" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-352"><a href="#cb14-352" aria-hidden="true" tabindex="-1"></a>bmt.cox <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(t2, d3) <span class="sc">~</span> group, <span class="at">data =</span> bmt)</span>
<span id="cb14-353"><a href="#cb14-353" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bmt.cox)</span>
<span id="cb14-354"><a href="#cb14-354" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-355"><a href="#cb14-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-356"><a href="#cb14-356" aria-hidden="true" tabindex="-1"></a>The table provides hypothesis tests comparing groups 2 and 3 to group 1.</span>
<span id="cb14-357"><a href="#cb14-357" aria-hidden="true" tabindex="-1"></a>Group 3 has the highest hazard, so the most significant comparison is</span>
<span id="cb14-358"><a href="#cb14-358" aria-hidden="true" tabindex="-1"></a>not directly shown.</span>
<span id="cb14-359"><a href="#cb14-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-360"><a href="#cb14-360" aria-hidden="true" tabindex="-1"></a>The coefficient 0.3834 is on the log-hazard-ratio scale, as in</span>
<span id="cb14-361"><a href="#cb14-361" aria-hidden="true" tabindex="-1"></a>log-risk-ratio. The next column gives the hazard ratio 1.4673, and a</span>
<span id="cb14-362"><a href="#cb14-362" aria-hidden="true" tabindex="-1"></a>hypothesis (Wald) test.</span>
<span id="cb14-363"><a href="#cb14-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-364"><a href="#cb14-364" aria-hidden="true" tabindex="-1"></a>The (not shown) group 3 vs. group 2 log hazard ratio is 0.3834 + 0.5742</span>
<span id="cb14-365"><a href="#cb14-365" aria-hidden="true" tabindex="-1"></a>= 0.9576. The hazard ratio is then exp(0.9576) or 2.605.</span>
<span id="cb14-366"><a href="#cb14-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-367"><a href="#cb14-367" aria-hidden="true" tabindex="-1"></a>Inference on all coefficients and combinations can be constructed using</span>
<span id="cb14-368"><a href="#cb14-368" aria-hidden="true" tabindex="-1"></a><span class="in">`coef(bmt.cox)`</span> and <span class="in">`vcov(bmt.cox)`</span> as with logistic and poisson</span>
<span id="cb14-369"><a href="#cb14-369" aria-hidden="true" tabindex="-1"></a>regression.</span>
<span id="cb14-370"><a href="#cb14-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-371"><a href="#cb14-371" aria-hidden="true" tabindex="-1"></a>**Concordance** is agreement of first failure between pairs of subjects</span>
<span id="cb14-372"><a href="#cb14-372" aria-hidden="true" tabindex="-1"></a>and higher predicted risk between those subjects, omitting</span>
<span id="cb14-373"><a href="#cb14-373" aria-hidden="true" tabindex="-1"></a>non-informative pairs.</span>
<span id="cb14-374"><a href="#cb14-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-375"><a href="#cb14-375" aria-hidden="true" tabindex="-1"></a>The Rsquare value is Cox and Snell's pseudo R-squared and is not very</span>
<span id="cb14-376"><a href="#cb14-376" aria-hidden="true" tabindex="-1"></a>useful.</span>
<span id="cb14-377"><a href="#cb14-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-378"><a href="#cb14-378" aria-hidden="true" tabindex="-1"></a><span class="in">`summary()`</span> prints three tests for whether the model with the group</span>
<span id="cb14-379"><a href="#cb14-379" aria-hidden="true" tabindex="-1"></a>covariate is better than the one without</span>
<span id="cb14-380"><a href="#cb14-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-381"><a href="#cb14-381" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`Likelihood ratio test`</span> (chi-squared)</span>
<span id="cb14-382"><a href="#cb14-382" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`Wald test`</span> (also chi-squared), obtained by adding the squares of the z-scores</span>
<span id="cb14-383"><a href="#cb14-383" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`Score`</span> = log-rank test, as with comparison of survival functions.</span>
<span id="cb14-384"><a href="#cb14-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-385"><a href="#cb14-385" aria-hidden="true" tabindex="-1"></a>The likelihood ratio test is probably best in smaller samples, followed</span>
<span id="cb14-386"><a href="#cb14-386" aria-hidden="true" tabindex="-1"></a>by the Wald test.</span>
<span id="cb14-387"><a href="#cb14-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-388"><a href="#cb14-388" aria-hidden="true" tabindex="-1"></a><span class="fu">### Survival Curves from the Cox Model</span></span>
<span id="cb14-389"><a href="#cb14-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-390"><a href="#cb14-390" aria-hidden="true" tabindex="-1"></a>We can take a look at the resulting group-specific curves:</span>
<span id="cb14-391"><a href="#cb14-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-394"><a href="#cb14-394" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-395"><a href="#cb14-395" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Survival Functions for Three Groups by KM and Cox Model"</span></span>
<span id="cb14-396"><a href="#cb14-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-397"><a href="#cb14-397" aria-hidden="true" tabindex="-1"></a>km_fit <span class="ot">=</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(t2, d3) <span class="sc">~</span> group, <span class="at">data =</span> <span class="fu">as.data.frame</span>(bmt))</span>
<span id="cb14-398"><a href="#cb14-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-399"><a href="#cb14-399" aria-hidden="true" tabindex="-1"></a>cox_fit <span class="ot">=</span> <span class="fu">survfit</span>(</span>
<span id="cb14-400"><a href="#cb14-400" aria-hidden="true" tabindex="-1"></a>  bmt.cox, </span>
<span id="cb14-401"><a href="#cb14-401" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> </span>
<span id="cb14-402"><a href="#cb14-402" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb14-403"><a href="#cb14-403" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> <span class="fu">unique</span>(bmt<span class="sc">$</span>group), </span>
<span id="cb14-404"><a href="#cb14-404" aria-hidden="true" tabindex="-1"></a>      <span class="at">row.names =</span> <span class="fu">unique</span>(bmt<span class="sc">$</span>group)))</span>
<span id="cb14-405"><a href="#cb14-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-406"><a href="#cb14-406" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer)</span>
<span id="cb14-407"><a href="#cb14-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-408"><a href="#cb14-408" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="at">KM =</span> km_fit, <span class="at">Cox =</span> cox_fit) <span class="sc">|&gt;</span> </span>
<span id="cb14-409"><a href="#cb14-409" aria-hidden="true" tabindex="-1"></a>  survminer<span class="sc">::</span><span class="fu">ggsurvplot</span>(</span>
<span id="cb14-410"><a href="#cb14-410" aria-hidden="true" tabindex="-1"></a>    <span class="co"># facet.by = "group",</span></span>
<span id="cb14-411"><a href="#cb14-411" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend =</span> <span class="st">"bottom"</span>, </span>
<span id="cb14-412"><a href="#cb14-412" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="st">""</span>,</span>
<span id="cb14-413"><a href="#cb14-413" aria-hidden="true" tabindex="-1"></a>    <span class="at">combine =</span> <span class="cn">TRUE</span>, </span>
<span id="cb14-414"><a href="#cb14-414" aria-hidden="true" tabindex="-1"></a>    <span class="at">fun =</span> <span class="st">'pct'</span>, </span>
<span id="cb14-415"><a href="#cb14-415" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> .<span class="dv">5</span>,</span>
<span id="cb14-416"><a href="#cb14-416" aria-hidden="true" tabindex="-1"></a>    <span class="at">ggtheme =</span> <span class="fu">theme_bw</span>(), </span>
<span id="cb14-417"><a href="#cb14-417" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.int =</span> <span class="cn">FALSE</span>, </span>
<span id="cb14-418"><a href="#cb14-418" aria-hidden="true" tabindex="-1"></a>    <span class="at">censor =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-419"><a href="#cb14-419" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>() <span class="co"># ggsurvplot() throws some warnings that aren't too worrying</span></span>
<span id="cb14-420"><a href="#cb14-420" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-421"><a href="#cb14-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-422"><a href="#cb14-422" aria-hidden="true" tabindex="-1"></a>When we use <span class="in">`survfit()`</span> with a Cox model, we have to specify the covariate levels we are interested in; the argument <span class="in">`newdata`</span> should include a <span class="in">`data.frame`</span> with the same named columns as the predictors in the Cox model and one or more levels of each.</span>
<span id="cb14-423"><a href="#cb14-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-424"><a href="#cb14-424" aria-hidden="true" tabindex="-1"></a>Otherwise (that is, if the <span class="in">`newdata`</span> argument is missing), a curve is produced for a single "pseudo" subject with covariate values equal to the means component of the fit. </span>
<span id="cb14-425"><a href="#cb14-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-426"><a href="#cb14-426" aria-hidden="true" tabindex="-1"></a>The resulting curve(s) almost never make sense, but the default remains due to an unwarranted attachment to the</span>
<span id="cb14-427"><a href="#cb14-427" aria-hidden="true" tabindex="-1"></a>option shown by some users and by other packages.</span>
<span id="cb14-428"><a href="#cb14-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-429"><a href="#cb14-429" aria-hidden="true" tabindex="-1"></a>Two particularly egregious examples are factor variables and</span>
<span id="cb14-430"><a href="#cb14-430" aria-hidden="true" tabindex="-1"></a>interactions. Suppose one were studying interspecies transmission of a virus, and the data set has a factor variable with levels ("pig", "chicken") and about equal numbers of observations for each. The "mean" covariate level will be 0.5 -- is this a flying pig?</span>
<span id="cb14-431"><a href="#cb14-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-432"><a href="#cb14-432" aria-hidden="true" tabindex="-1"></a><span class="fu">### Examining `survfit`</span></span>
<span id="cb14-433"><a href="#cb14-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-436"><a href="#cb14-436" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-437"><a href="#cb14-437" aria-hidden="true" tabindex="-1"></a><span class="fu">survfit</span>(<span class="fu">Surv</span>(t2, d3)<span class="sc">~</span>group,<span class="at">data=</span>bmt)</span>
<span id="cb14-438"><a href="#cb14-438" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-439"><a href="#cb14-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-442"><a href="#cb14-442" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-443"><a href="#cb14-443" aria-hidden="true" tabindex="-1"></a><span class="fu">survfit</span>(<span class="fu">Surv</span>(t2, d3)<span class="sc">~</span>group,<span class="at">data=</span>bmt) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb14-444"><a href="#cb14-444" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-445"><a href="#cb14-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-448"><a href="#cb14-448" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-449"><a href="#cb14-449" aria-hidden="true" tabindex="-1"></a><span class="fu">survfit</span>(bmt.cox)</span>
<span id="cb14-450"><a href="#cb14-450" aria-hidden="true" tabindex="-1"></a><span class="fu">survfit</span>(bmt.cox, <span class="at">newdata =</span> <span class="fu">tibble</span>(<span class="at">group =</span> <span class="fu">unique</span>(bmt<span class="sc">$</span>group)))</span>
<span id="cb14-451"><a href="#cb14-451" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-452"><a href="#cb14-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-455"><a href="#cb14-455" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-456"><a href="#cb14-456" aria-hidden="true" tabindex="-1"></a>bmt.cox <span class="sc">|&gt;</span> </span>
<span id="cb14-457"><a href="#cb14-457" aria-hidden="true" tabindex="-1"></a>  <span class="fu">survfit</span>(<span class="at">newdata =</span> <span class="fu">tibble</span>(<span class="at">group =</span> <span class="fu">unique</span>(bmt<span class="sc">$</span>group))) <span class="sc">|&gt;</span> </span>
<span id="cb14-458"><a href="#cb14-458" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span>
<span id="cb14-459"><a href="#cb14-459" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-460"><a href="#cb14-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-461"><a href="#cb14-461" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adjustment for Ties (optional)</span></span>
<span id="cb14-462"><a href="#cb14-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-463"><a href="#cb14-463" aria-hidden="true" tabindex="-1"></a>###</span>
<span id="cb14-464"><a href="#cb14-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-465"><a href="#cb14-465" aria-hidden="true" tabindex="-1"></a>At each time $t_i$ at which more than one of the subjects has an event,</span>
<span id="cb14-466"><a href="#cb14-466" aria-hidden="true" tabindex="-1"></a>let $d_i$ be the number of events at that time, $D_i$ the set of</span>
<span id="cb14-467"><a href="#cb14-467" aria-hidden="true" tabindex="-1"></a>subjects with events at that time, and let $s_i$ be a covariate vector</span>
<span id="cb14-468"><a href="#cb14-468" aria-hidden="true" tabindex="-1"></a>for an artificial subject obtained by adding up the covariate values for</span>
<span id="cb14-469"><a href="#cb14-469" aria-hidden="true" tabindex="-1"></a>the subjects with an event at time $t_i$. Let</span>
<span id="cb14-470"><a href="#cb14-470" aria-hidden="true" tabindex="-1"></a>$$\bar\eta_i = \beta_1s_{i1}+\cdots+\beta_ps_{ip}$$ and</span>
<span id="cb14-471"><a href="#cb14-471" aria-hidden="true" tabindex="-1"></a>$\bar\theta_i = \exp{\bar\eta_i}$.</span>
<span id="cb14-472"><a href="#cb14-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-473"><a href="#cb14-473" aria-hidden="true" tabindex="-1"></a>Let $s_i$ be a covariate vector for an artificial subject obtained by</span>
<span id="cb14-474"><a href="#cb14-474" aria-hidden="true" tabindex="-1"></a>adding up the covariate values for the subjects with an event at time</span>
<span id="cb14-475"><a href="#cb14-475" aria-hidden="true" tabindex="-1"></a>$t_i$. Note that </span>
<span id="cb14-476"><a href="#cb14-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-477"><a href="#cb14-477" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-478"><a href="#cb14-478" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb14-479"><a href="#cb14-479" aria-hidden="true" tabindex="-1"></a>\bar\eta_i &amp;=\sum_{j \in D_i}\beta_1x_{j1}+\cdots+\beta_px_{jp}<span class="sc">\\</span></span>
<span id="cb14-480"><a href="#cb14-480" aria-hidden="true" tabindex="-1"></a>&amp;= \beta_1s_{i1}+\cdots+\beta_ps_{ip}<span class="sc">\\</span></span>
<span id="cb14-481"><a href="#cb14-481" aria-hidden="true" tabindex="-1"></a>\bar\theta_i &amp;= \exp{\bar\eta_i}<span class="sc">\\</span></span>
<span id="cb14-482"><a href="#cb14-482" aria-hidden="true" tabindex="-1"></a>&amp;= \prod_{j \in D_i}\theta_i</span>
<span id="cb14-483"><a href="#cb14-483" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb14-484"><a href="#cb14-484" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-485"><a href="#cb14-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-486"><a href="#cb14-486" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Breslow's method for ties</span></span>
<span id="cb14-487"><a href="#cb14-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-488"><a href="#cb14-488" aria-hidden="true" tabindex="-1"></a>Breslow's method estimates the partial likelihood as</span>
<span id="cb14-489"><a href="#cb14-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-490"><a href="#cb14-490" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-491"><a href="#cb14-491" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb14-492"><a href="#cb14-492" aria-hidden="true" tabindex="-1"></a>L(\beta|T) &amp;=</span>
<span id="cb14-493"><a href="#cb14-493" aria-hidden="true" tabindex="-1"></a>\prod_i \frac{\bar\theta_i}{<span class="co">[</span><span class="ot">\sum_{k \in R(t_i)} \theta_k</span><span class="co">]</span>^{d_i}}<span class="sc">\\</span></span>
<span id="cb14-494"><a href="#cb14-494" aria-hidden="true" tabindex="-1"></a>&amp;= \prod_i \prod_{j \in D_i}\frac{\theta_j}{\sum_{k \in R(t_i)} \theta_k}</span>
<span id="cb14-495"><a href="#cb14-495" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb14-496"><a href="#cb14-496" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-497"><a href="#cb14-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-498"><a href="#cb14-498" aria-hidden="true" tabindex="-1"></a>This method is equivalent to treating each event as distinct and using the non-ties formula. </span>
<span id="cb14-499"><a href="#cb14-499" aria-hidden="true" tabindex="-1"></a>It works best when the number of ties is small. </span>
<span id="cb14-500"><a href="#cb14-500" aria-hidden="true" tabindex="-1"></a>It is the default in many statistical packages, including PROC PHREG in SAS.</span>
<span id="cb14-501"><a href="#cb14-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-502"><a href="#cb14-502" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Efron's method for ties</span></span>
<span id="cb14-503"><a href="#cb14-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-504"><a href="#cb14-504" aria-hidden="true" tabindex="-1"></a>The other common method is Efron's, which is the default in R.</span>
<span id="cb14-505"><a href="#cb14-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-506"><a href="#cb14-506" aria-hidden="true" tabindex="-1"></a>$$L(\beta|T)=</span>
<span id="cb14-507"><a href="#cb14-507" aria-hidden="true" tabindex="-1"></a>\prod_i \frac{\bar\theta_i}{\prod_{j=1}^{d_i}<span class="co">[</span><span class="ot">\sum_{k \in R(t_i)} \theta_k-\frac{j-1}{d_i}\sum_{k \in D_i} \theta_k</span><span class="co">]</span>}$$</span>
<span id="cb14-508"><a href="#cb14-508" aria-hidden="true" tabindex="-1"></a>This is closer to the exact discrete partial likelihood when there are</span>
<span id="cb14-509"><a href="#cb14-509" aria-hidden="true" tabindex="-1"></a>many ties.</span>
<span id="cb14-510"><a href="#cb14-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-511"><a href="#cb14-511" aria-hidden="true" tabindex="-1"></a>The third option in R (and an option also in SAS as <span class="in">`discrete`</span>) is the</span>
<span id="cb14-512"><a href="#cb14-512" aria-hidden="true" tabindex="-1"></a>"exact" method, which is the same one used for matched logistic</span>
<span id="cb14-513"><a href="#cb14-513" aria-hidden="true" tabindex="-1"></a>regression.</span>
<span id="cb14-514"><a href="#cb14-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-515"><a href="#cb14-515" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Example: Breslow's method</span></span>
<span id="cb14-516"><a href="#cb14-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-517"><a href="#cb14-517" aria-hidden="true" tabindex="-1"></a>Suppose as an example we have a time $t$ where there are 20 individuals</span>
<span id="cb14-518"><a href="#cb14-518" aria-hidden="true" tabindex="-1"></a>at risk and three failures. Let the three individuals have risk</span>
<span id="cb14-519"><a href="#cb14-519" aria-hidden="true" tabindex="-1"></a>parameters $\theta_1, \theta_2, \theta_3$ and let the sum of the risk</span>
<span id="cb14-520"><a href="#cb14-520" aria-hidden="true" tabindex="-1"></a>parameters of the remaining 17 individuals be $\theta_R$. Then the</span>
<span id="cb14-521"><a href="#cb14-521" aria-hidden="true" tabindex="-1"></a>factor in the partial likelihood at time $t$ using Breslow's method is</span>
<span id="cb14-522"><a href="#cb14-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-523"><a href="#cb14-523" aria-hidden="true" tabindex="-1"></a>::: smaller</span>
<span id="cb14-524"><a href="#cb14-524" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-525"><a href="#cb14-525" aria-hidden="true" tabindex="-1"></a>\left(\frac{\theta_1}{\theta_R+\theta_1+\theta_2+\theta_3}\right)</span>
<span id="cb14-526"><a href="#cb14-526" aria-hidden="true" tabindex="-1"></a>\left(\frac{\theta_2}{\theta_R+\theta_1+\theta_2+\theta_3}\right)</span>
<span id="cb14-527"><a href="#cb14-527" aria-hidden="true" tabindex="-1"></a>\left(\frac{\theta_3}{\theta_R+\theta_1+\theta_2+\theta_3}\right)</span>
<span id="cb14-528"><a href="#cb14-528" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-529"><a href="#cb14-529" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb14-530"><a href="#cb14-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-531"><a href="#cb14-531" aria-hidden="true" tabindex="-1"></a>If on the other hand, they had died in the order 1,2, 3, then the</span>
<span id="cb14-532"><a href="#cb14-532" aria-hidden="true" tabindex="-1"></a>contribution to the partial likelihood would be:</span>
<span id="cb14-533"><a href="#cb14-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-534"><a href="#cb14-534" aria-hidden="true" tabindex="-1"></a>::: smaller</span>
<span id="cb14-535"><a href="#cb14-535" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-536"><a href="#cb14-536" aria-hidden="true" tabindex="-1"></a>\left(\frac{\theta_1}{\theta_R+\theta_1+\theta_2+\theta_3}\right)</span>
<span id="cb14-537"><a href="#cb14-537" aria-hidden="true" tabindex="-1"></a>\left(\frac{\theta_2}{\theta_R+\theta_2+\theta_3}\right)</span>
<span id="cb14-538"><a href="#cb14-538" aria-hidden="true" tabindex="-1"></a>\left(\frac{\theta_3}{\theta_R+\theta_3}\right)</span>
<span id="cb14-539"><a href="#cb14-539" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-540"><a href="#cb14-540" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb14-541"><a href="#cb14-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-542"><a href="#cb14-542" aria-hidden="true" tabindex="-1"></a>as the risk set got smaller with each failure. The exact method roughly</span>
<span id="cb14-543"><a href="#cb14-543" aria-hidden="true" tabindex="-1"></a>averages the results for the six possible orderings of the failures.</span>
<span id="cb14-544"><a href="#cb14-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-545"><a href="#cb14-545" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Example: Efron's method</span></span>
<span id="cb14-546"><a href="#cb14-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-547"><a href="#cb14-547" aria-hidden="true" tabindex="-1"></a>But we don't know the order they failed in, so instead of reducing the</span>
<span id="cb14-548"><a href="#cb14-548" aria-hidden="true" tabindex="-1"></a>denominator by one risk coefficient each time, we reduce it by the same</span>
<span id="cb14-549"><a href="#cb14-549" aria-hidden="true" tabindex="-1"></a>fraction. This is Efron's method.</span>
<span id="cb14-550"><a href="#cb14-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-551"><a href="#cb14-551" aria-hidden="true" tabindex="-1"></a>::: smaller</span>
<span id="cb14-552"><a href="#cb14-552" aria-hidden="true" tabindex="-1"></a>$$\left(\frac{\theta_1}{\theta_R+\theta_1+\theta_2+\theta_3}\right)</span>
<span id="cb14-553"><a href="#cb14-553" aria-hidden="true" tabindex="-1"></a>\left(\frac{\theta_2}{\theta_R+2(\theta_1+\theta_2+\theta_3)/3}\right)</span>
<span id="cb14-554"><a href="#cb14-554" aria-hidden="true" tabindex="-1"></a>\left(\frac{\theta_3}{\theta_R+(\theta_1+\theta_2+\theta_3)/3}\right)$$</span>
<span id="cb14-555"><a href="#cb14-555" aria-hidden="true" tabindex="-1"></a>:::</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
<li class="nav-item">
 Copyright 2024, Douglas Ezra Morrison
  </li>  
</ul>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/d-morrison/rme/edit/main/proportional-hazards-models.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/d-morrison/rme/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>


</body></html>